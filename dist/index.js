(()=>{"use strict";var e={208:(e,t,s)=>{s.d(t,{A:()=>o});var n=s(601),r=s.n(n),i=s(314),a=s.n(i)()(r());a.push([e.id,"#spotify_template {\n    field-sizing: content;\n}\n",""]);const o=a},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var s="",n=void 0!==t[5];return t[4]&&(s+="@supports (".concat(t[4],") {")),t[2]&&(s+="@media ".concat(t[2]," {")),n&&(s+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),s+=e(t),n&&(s+="}"),t[2]&&(s+="}"),t[4]&&(s+="}"),s})).join("")},t.i=function(e,s,n,r,i){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(n)for(var o=0;o<this.length;o++){var c=this[o][0];null!=c&&(a[c]=!0)}for(var u=0;u<e.length;u++){var h=[].concat(e[u]);n&&a[h[0]]||(void 0!==i&&(void 0===h[5]||(h[1]="@layer".concat(h[5].length>0?" ".concat(h[5]):""," {").concat(h[1],"}")),h[5]=i),s&&(h[2]?(h[1]="@media ".concat(h[2]," {").concat(h[1],"}"),h[2]=s):h[2]=s),r&&(h[4]?(h[1]="@supports (".concat(h[4],") {").concat(h[1],"}"),h[4]=r):h[4]="".concat(r)),t.push(h))}},t}},601:e=>{e.exports=function(e){return e[1]}},72:e=>{var t=[];function s(e){for(var s=-1,n=0;n<t.length;n++)if(t[n].identifier===e){s=n;break}return s}function n(e,n){for(var i={},a=[],o=0;o<e.length;o++){var c=e[o],u=n.base?c[0]+n.base:c[0],h=i[u]||0,l="".concat(u," ").concat(h);i[u]=h+1;var p=s(l),d={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==p)t[p].references++,t[p].updater(d);else{var f=r(d,n);n.byIndex=o,t.splice(o,0,{identifier:l,updater:f,references:1})}a.push(l)}return a}function r(e,t){var s=t.domAPI(t);s.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;s.update(e=t)}else s.remove()}}e.exports=function(e,r){var i=n(e=e||[],r=r||{});return function(e){e=e||[];for(var a=0;a<i.length;a++){var o=s(i[a]);t[o].references--}for(var c=n(e,r),u=0;u<i.length;u++){var h=s(i[u]);0===t[h].references&&(t[h].updater(),t.splice(h,1))}i=c}}},659:e=>{var t={};e.exports=function(e,s){var n=function(e){if(void 0===t[e]){var s=document.querySelector(e);if(window.HTMLIFrameElement&&s instanceof window.HTMLIFrameElement)try{s=s.contentDocument.head}catch(e){s=null}t[e]=s}return t[e]}(e);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");n.appendChild(s)}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56:(e,t,s)=>{e.exports=function(e){var t=s.nc;t&&e.setAttribute("nonce",t)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(s){!function(e,t,s){var n="";s.supports&&(n+="@supports (".concat(s.supports,") {")),s.media&&(n+="@media ".concat(s.media," {"));var r=void 0!==s.layer;r&&(n+="@layer".concat(s.layer.length>0?" ".concat(s.layer):""," {")),n+=s.css,r&&(n+="}"),s.media&&(n+="}"),s.supports&&(n+="}");var i=s.sourceMap;i&&"undefined"!=typeof btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(n,e,t.options)}(t,e,s)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}},t={};function s(n){var r=t[n];if(void 0!==r)return r.exports;var i=t[n]={id:n,exports:{}};return e[n](i,i.exports,s),i.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.nc=void 0;class n{api;constructor(e){this.api=e}async getRequest(e){return await this.api.makeRequest("GET",e)}async postRequest(e,t,s=void 0){return await this.api.makeRequest("POST",e,t,s)}async putRequest(e,t,s=void 0){return await this.api.makeRequest("PUT",e,t,s)}async deleteRequest(e,t){return await this.api.makeRequest("DELETE",e,t)}paramsFor(e){const t=new URLSearchParams;for(let s of Object.getOwnPropertyNames(e))(e[s]||0===e[s]||!e[s]&&"boolean"==typeof e[s])&&t.append(s,e[s].toString());return[...t].length>0?`?${t.toString()}`:""}}class r extends n{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return await this.getRequest(`albums/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`albums${s}`)).albums}tracks(e,t,s,n){const r=this.paramsFor({market:t,limit:s,offset:n});return this.getRequest(`albums/${e}/tracks${r}`)}}class i extends n{async get(e){if("string"==typeof e){return this.getRequest(`artists/${e}`)}const t=this.paramsFor({ids:e});return(await this.getRequest(`artists${t}`)).artists}albums(e,t,s,n,r){const i=this.paramsFor({include_groups:t,market:s,limit:n,offset:r});return this.getRequest(`artists/${e}/albums${i}`)}topTracks(e,t){const s=this.paramsFor({market:t});return this.getRequest(`artists/${e}/top-tracks${s}`)}relatedArtists(e){return this.getRequest(`artists/${e}/related-artists`)}}class a extends n{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`audiobooks/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`audiobooks${s}`)).audiobooks}getAudiobookChapters(e,t,s,n){const r=this.paramsFor({market:t,limit:s,offset:n});return this.getRequest(`audiobooks/${e}/chapters${r}`)}}class o extends n{getCategories(e,t,s,n){const r=this.paramsFor({country:e,locale:t,limit:s,offset:n});return this.getRequest(`browse/categories${r}`)}getCategory(e,t,s){const n=this.paramsFor({country:t,locale:s});return this.getRequest(`browse/categories/${e}${n}`)}getNewReleases(e,t,s){const n=this.paramsFor({country:e,limit:t,offset:s});return this.getRequest(`browse/new-releases${n}`)}getFeaturedPlaylists(e,t,s,n,r){const i=this.paramsFor({country:e,locale:t,timestamp:s,limit:n,offset:r});return this.getRequest(`browse/featured-playlists${i}`)}getPlaylistsForCategory(e,t,s,n){const r=this.paramsFor({country:t,limit:s,offset:n});return this.getRequest(`browse/categories/${e}/playlists${r}`)}}class c extends n{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`chapters/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`chapters${s}`)).chapters}}class u extends n{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`episodes/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`episodes${s}`)).episodes}}class h extends n{get(e){const t=this.paramsFor(e);return this.getRequest(`recommendations${t}`)}genreSeeds(){return this.getRequest("recommendations/available-genre-seeds")}}class l extends n{getAvailableMarkets(){return this.getRequest("markets")}}class p extends n{getPlaybackState(e,t){const s=this.paramsFor({market:e,additional_types:t});return this.getRequest(`me/player${s}`)}getAvailableDevices(){return this.getRequest("me/player/devices")}getCurrentlyPlayingTrack(e,t){const s=this.paramsFor({market:e,additional_types:t});return this.getRequest(`me/player/currently-playing${s}`)}getRecentlyPlayedTracks(e,t){const s={limit:e};t&&("before"===t.type?s.before=t.timestamp:"after"===t.type&&(s.after=t.timestamp));const n=this.paramsFor(s);return this.getRequest(`me/player/recently-played${n}`)}getUsersQueue(){return this.getRequest("me/player/queue")}async transferPlayback(e,t){if(e.length>1)throw new Error("Although an array is accepted, only a single device_id is currently supported. Supplying more than one will return 400 Bad Request");await this.putRequest("me/player",{device_ids:e,play:t})}async startResumePlayback(e,t,s,n,r){const i=this.paramsFor({device_id:e});await this.putRequest(`me/player/play${i}`,{context_uri:t,uris:s,offset:n,positionMs:r})}async pausePlayback(e){const t=this.paramsFor({device_id:e});await this.putRequest(`me/player/pause${t}`)}async skipToNext(e){const t=this.paramsFor({device_id:e});await this.postRequest(`me/player/next${t}`)}async skipToPrevious(e){const t=this.paramsFor({device_id:e});await this.postRequest(`me/player/previous${t}`)}async seekToPosition(e,t){const s=this.paramsFor({position_ms:e,device_id:t});await this.putRequest(`me/player/seek${s}`)}async setRepeatMode(e,t){const s=this.paramsFor({state:e,device_id:t});await this.putRequest(`me/player/repeat${s}`)}async setPlaybackVolume(e,t){const s=this.paramsFor({volume_percent:e,device_id:t});await this.putRequest(`me/player/volume${s}`)}async togglePlaybackShuffle(e,t){const s=this.paramsFor({state:e,device_id:t});await this.putRequest(`me/player/shuffle${s}`)}async addItemToPlaybackQueue(e,t){const s=this.paramsFor({uri:e,device_id:t});await this.postRequest(`me/player/queue${s}`)}}class d extends n{getPlaylist(e,t,s,n){const r=this.paramsFor({market:t,fields:s,additional_types:n?.join(",")});return this.getRequest(`playlists/${e}${r}`)}getPlaylistItems(e,t,s,n,r,i){const a=this.paramsFor({market:t,fields:s,limit:n,offset:r,additional_types:i?.join(",")});return this.getRequest(`playlists/${e}/tracks${a}`)}async changePlaylistDetails(e,t){await this.putRequest(`playlists/${e}`,t)}movePlaylistItems(e,t,s,n){return this.updatePlaylistItems(e,{range_start:t,range_length:s,insert_before:n})}updatePlaylistItems(e,t){return this.putRequest(`playlists/${e}/tracks`,t)}async addItemsToPlaylist(e,t,s){await this.postRequest(`playlists/${e}/tracks`,{position:s,uris:t})}async removeItemsFromPlaylist(e,t){await this.deleteRequest(`playlists/${e}/tracks`,t)}getUsersPlaylists(e,t,s){const n=this.paramsFor({limit:t,offset:s});return this.getRequest(`users/${e}/playlists${n}`)}createPlaylist(e,t){return this.postRequest(`users/${e}/playlists`,t)}getPlaylistCoverImage(e){return this.getRequest(`playlists/${e}/images`)}async addCustomPlaylistCoverImage(e,t){let s="";if(t instanceof Buffer)s=t.toString("base64");else if(t instanceof HTMLCanvasElement)s=t.toDataURL("image/jpeg").split(";base64,")[1];else if(t instanceof HTMLImageElement){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const n=e.getContext("2d");if(!n)throw new Error("Could not get canvas context");n.drawImage(t,0,0),s=e.toDataURL("image/jpeg").split(";base64,")[1]}else{if("string"!=typeof t)throw new Error("ImageData must be a Buffer, HTMLImageElement, HTMLCanvasElement, or string containing a base64 encoded jpeg");s=t}await this.addCustomPlaylistCoverImageFromBase64String(e,s)}async addCustomPlaylistCoverImageFromBase64String(e,t){await this.putRequest(`playlists/${e}/images`,t,"image/jpeg")}}class f extends n{async execute(e,t,s,n,r,i){const a=this.paramsFor({q:e,type:t,market:s,limit:n,offset:r,include_external:i});return await this.getRequest(`search${a}`)}}class y extends n{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`shows/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`shows${s}`)).shows}episodes(e,t,s,n){const r=this.paramsFor({market:t,limit:s,offset:n});return this.getRequest(`shows/${e}/episodes${r}`)}}class m extends n{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`tracks/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`tracks${s}`)).tracks}async audioFeatures(e){if("string"==typeof e)return this.getRequest(`audio-features/${e}`);const t=this.paramsFor({ids:e});return(await this.getRequest(`audio-features${t}`)).audio_features}audioAnalysis(e){return this.getRequest(`audio-analysis/${e}`)}}const g={access_token:"emptyAccessToken",token_type:"",expires_in:0,refresh_token:"",expires:-1};function w(e){return e===g}class v extends n{profile(e){return this.getRequest(`users/${e}`)}}class k extends n{albums;audiobooks;episodes;playlists;shows;tracks;constructor(e){super(e),this.albums=new b(e),this.audiobooks=new S(e),this.episodes=new R(e),this.playlists=new _(e),this.shows=new T(e),this.tracks=new x(e)}profile(){return this.getRequest("me")}topItems(e,t,s,n){const r=this.paramsFor({time_range:t,limit:s,offset:n});return this.getRequest(`me/top/${e}${r}`)}followedArtists(e,t){const s=this.paramsFor({type:"artist",after:e,limit:t});return this.getRequest(`me/following${s}`)}async followArtistsOrUsers(e,t){const s=this.paramsFor({type:t});await this.putRequest(`me/following${s}`,{ids:e})}async unfollowArtistsOrUsers(e,t){const s=this.paramsFor({type:t});await this.deleteRequest(`me/following${s}`,{ids:e})}followsArtistsOrUsers(e,t){const s=this.paramsFor({ids:e,type:t});return this.getRequest(`me/following/contains${s}`)}}class b extends n{savedAlbums(e,t,s){const n=this.paramsFor({limit:e,offset:t,market:s});return this.getRequest(`me/albums${n}`)}async saveAlbums(e){await this.putRequest("me/albums",e)}async removeSavedAlbums(e){await this.deleteRequest("me/albums",e)}hasSavedAlbums(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/albums/contains${t}`)}}class S extends n{savedAudiobooks(e,t){const s=this.paramsFor({limit:e,offset:t});return this.getRequest(`me/audiobooks${s}`)}async saveAudiobooks(e){await this.putRequest("me/audiobooks",e)}async removeSavedAudiobooks(e){await this.deleteRequest("me/audiobooks",e)}hasSavedAudiobooks(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/audiobooks/contains${t}`)}}class R extends n{savedEpisodes(e,t,s){const n=this.paramsFor({market:e,limit:t,offset:s});return this.getRequest(`me/episodes${n}`)}async saveEpisodes(e){await this.putRequest("me/episodes",e)}async removeSavedEpisodes(e){await this.deleteRequest("me/episodes",e)}hasSavedEpisodes(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/episodes/contains${t}`)}}class _ extends n{playlists(e,t){const s=this.paramsFor({limit:e,offset:t});return this.getRequest(`me/playlists${s}`)}async follow(e){await this.putRequest(`playlists/${e}/followers`)}async unfollow(e){await this.deleteRequest(`playlists/${e}/followers`)}isFollowing(e,t){const s=this.paramsFor({ids:t});return this.getRequest(`playlists/${e}/followers/contains${s}`)}}class T extends n{savedShows(e,t){const s=this.paramsFor({limit:e,offset:t});return this.getRequest(`me/shows${s}`)}saveShows(e){const t=this.paramsFor({ids:e});return this.putRequest(`me/shows${t}`)}removeSavedShows(e,t){const s=this.paramsFor({ids:e,market:t});return this.deleteRequest(`me/shows${s}`)}hasSavedShow(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/shows/contains${t}`)}}class x extends n{savedTracks(e,t,s){const n=this.paramsFor({limit:e,offset:t,market:s});return this.getRequest(`me/tracks${n}`)}async saveTracks(e){await this.putRequest("me/tracks",e)}async removeSavedTracks(e){await this.deleteRequest("me/tracks",e)}hasSavedTracks(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/tracks/contains${t}`)}}class C{static get current(){return this.hasSubtleCrypto?window.crypto:this.tryLoadNodeWebCrypto()}static get hasSubtleCrypto(){return"undefined"!=typeof window&&void 0!==window.crypto&&void 0!==window.crypto.subtle}static tryLoadNodeWebCrypto(){try{const{webcrypto:e}=require("crypto");return e}catch(e){throw e}}}class q{static async refreshCachedAccessToken(e,t){const s=await q.refreshToken(e,t.refresh_token);return q.toCachable(s)}static toCachable(e){return e.expires&&-1===e.expires?e:{...e,expires:this.calculateExpiry(e)}}static calculateExpiry(e){return Date.now()+1e3*e.expires_in}static async refreshToken(e,t){const s=new URLSearchParams;s.append("client_id",e),s.append("grant_type","refresh_token"),s.append("refresh_token",t);const n=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s}),r=await n.text();if(!n.ok)throw new Error(`Failed to refresh token: ${n.statusText}, ${r}`);return JSON.parse(r)}static generateCodeVerifier(e){let t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let n=0;n<e;n++)t+=s.charAt(Math.floor(62*Math.random()));return t}static async generateCodeChallenge(e){const t=(new TextEncoder).encode(e),s=await C.current.subtle.digest("SHA-256",t),n=[...new Uint8Array(s)];return("undefined"!=typeof Buffer?Buffer.from(s).toString("base64"):btoa(String.fromCharCode.apply(null,n))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}}class A{clientId;clientSecret;scopes;static cacheKey="spotify-sdk:ClientCredentialsStrategy:token";configuration=null;get cache(){return this.configuration.cachingStrategy}constructor(e,t,s=[]){this.clientId=e,this.clientSecret=t,this.scopes=s}setConfiguration(e){this.configuration=e}async getOrCreateAccessToken(){return await this.cache.getOrCreate(A.cacheKey,(async()=>{const e=await this.getTokenFromApi();return q.toCachable(e)}),(async e=>{const t=await this.getTokenFromApi();return q.toCachable(t)}))}async getAccessToken(){return await this.cache.get(A.cacheKey)}removeAccessToken(){this.cache.remove(A.cacheKey)}async getTokenFromApi(){const e={grant_type:"client_credentials",scope:this.scopes.join(" ")},t=Object.keys(e).map((t=>t+"="+e[t])).join("&"),s="undefined"!=typeof Buffer,n=`${this.clientId}:${this.clientSecret}`,r=s?Buffer.from(n).toString("base64"):btoa(n),i=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${r}`},body:t});if(200!==i.status)throw new Error("Failed to get access token.");return await i.json()}}class I{clientId;redirectUri;scopes;static cacheKey="spotify-sdk:ImplicitGrantStrategy:token";configuration=null;get cache(){return this.configuration.cachingStrategy}constructor(e,t,s){this.clientId=e,this.redirectUri=t,this.scopes=s}setConfiguration(e){this.configuration=e}async getOrCreateAccessToken(){return await this.cache.getOrCreate(I.cacheKey,(async()=>{const e=await this.redirectOrVerifyToken();return q.toCachable(e)}),(async e=>q.refreshCachedAccessToken(this.clientId,e)))}async getAccessToken(){return await this.cache.get(I.cacheKey)}removeAccessToken(){this.cache.remove(I.cacheKey)}async redirectOrVerifyToken(){const e=new URLSearchParams(window.location.hash.substring(1)),t=e.get("access_token");if(t)return Promise.resolve({access_token:t,token_type:e.get("token_type")??"",expires_in:parseInt(e.get("expires_in")??"0"),refresh_token:e.get("refresh_token")??"",expires:Number(e.get("expires"))||0});var s=(this.scopes??[]).join(" ");const n=new URLSearchParams;n.append("client_id",this.clientId),n.append("response_type","token"),n.append("redirect_uri",this.redirectUri),n.append("scope",s);const r="https://accounts.spotify.com/authorize?"+n.toString();return this.configuration.redirectionStrategy.redirect(r),g}}class ${clientId;redirectUri;scopes;static cacheKey="spotify-sdk:AuthorizationCodeWithPKCEStrategy:token";configuration=null;get cache(){return this.configuration.cachingStrategy}constructor(e,t,s){this.clientId=e,this.redirectUri=t,this.scopes=s}setConfiguration(e){this.configuration=e}async getOrCreateAccessToken(){return await this.cache.getOrCreate($.cacheKey,(async()=>{const e=await this.redirectOrVerifyToken();return q.toCachable(e)}),(async e=>q.refreshCachedAccessToken(this.clientId,e)))}async getAccessToken(){return await this.cache.get($.cacheKey)}removeAccessToken(){this.cache.remove($.cacheKey)}async redirectOrVerifyToken(){const e=new URLSearchParams(window.location.search).get("code");if(e){const t=await this.verifyAndExchangeCode(e);return this.removeCodeFromUrl(),t}return this.redirectToSpotify(),g}async redirectToSpotify(){const e=q.generateCodeVerifier(128),t=await q.generateCodeChallenge(e),s={verifier:e,expiresOnAccess:!0};this.cache.setCacheItem("spotify-sdk:verifier",s);const n=await this.generateRedirectUrlForUser(this.scopes,t);await this.configuration.redirectionStrategy.redirect(n)}async verifyAndExchangeCode(e){const t=await this.cache.get("spotify-sdk:verifier"),s=t?.verifier;if(!s)throw new Error("No verifier found in cache - can't validate query string callback parameters.");return await this.configuration.redirectionStrategy.onReturnFromRedirect(),await this.exchangeCodeForToken(e,s)}removeCodeFromUrl(){const e=new URL(window.location.href);e.searchParams.delete("code");const t=e.search?e.href:e.href.replace("?","");window.history.replaceState({},document.title,t)}async generateRedirectUrlForUser(e,t){const s=e.join(" "),n=new URLSearchParams;return n.append("client_id",this.clientId),n.append("response_type","code"),n.append("redirect_uri",this.redirectUri),n.append("scope",s),n.append("code_challenge_method","S256"),n.append("code_challenge",t),`https://accounts.spotify.com/authorize?${n.toString()}`}async exchangeCodeForToken(e,t){const s=new URLSearchParams;s.append("client_id",this.clientId),s.append("grant_type","authorization_code"),s.append("code",e),s.append("redirect_uri",this.redirectUri),s.append("code_verifier",t);const n=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s}),r=await n.text();if(!n.ok)throw new Error(`Failed to exchange code for token: ${n.statusText}, ${r}`);return JSON.parse(r)}}class F{async deserialize(e){const t=await e.text();if(t.length>0){return JSON.parse(t)}return null}}class E{async validateResponse(e){switch(e.status){case 401:throw new Error("Bad or expired token. This can happen if the user revoked a token or the access token has expired. You should re-authenticate the user.");case 403:const t=await e.text();throw new Error(`Bad OAuth request (wrong consumer key, bad nonce, expired timestamp...). Unfortunately, re-authenticating the user won't help here. Body: ${t}`);case 429:throw new Error("The app has exceeded its rate limits.");default:if(!e.status.toString().startsWith("20")){const t=await e.text();throw new Error(`Unrecognised response code: ${e.status} - ${e.statusText}. Body: ${t}`)}}}}class U{async handleErrors(e){return!1}}class P{async redirect(e){document.location=e.toString()}async onReturnFromRedirect(){}}class L{storage;updateFunctions;autoRenewInterval;autoRenewWindow;constructor(e,t=new Map,s=0,n=12e4){this.storage=e,this.updateFunctions=t,this.autoRenewInterval=s,this.autoRenewWindow=n,this.autoRenewInterval>0&&setInterval((()=>this.autoRenewRenewableItems()),this.autoRenewInterval)}async getOrCreate(e,t,s){s&&this.updateFunctions.set(e,s);const n=await this.get(e);if(n)return n;const r=await t();if(!r)throw new Error("Could not create cache item");return w(r)||this.setCacheItem(e,r),r}async get(e){let t=this.storage.get(e),s=t?JSON.parse(t):null;if(this.itemDueToExpire(s)&&this.updateFunctions.has(e)){const n=this.updateFunctions.get(e);await this.tryUpdateItem(e,s,n),t=this.storage.get(e),s=t?JSON.parse(t):null}return s?s.expires&&(-1===s.expires||s.expires<=Date.now())?(this.remove(e),null):s.expiresOnAccess&&!0===s.expiresOnAccess?(this.remove(e),s):s:null}set(e,t,s){const n={...t,expires:Date.now()+s};this.setCacheItem(e,n)}setCacheItem(e,t){const s=JSON.stringify(t);this.storage.set(e,s)}remove(e){this.storage.remove(e)}itemDueToExpire(e){return!!e&&(!!e.expires&&e.expires-Date.now()<this.autoRenewWindow)}async autoRenewRenewableItems(){this.updateFunctions.forEach((async(e,t)=>{const s=await this.get(t);s&&e&&this.itemDueToExpire(s)&&await this.tryUpdateItem(t,s,e)}))}async tryUpdateItem(e,t,s){try{const n=await s(t);n&&this.setCacheItem(e,n)}catch(e){console.error(e)}}}class O extends L{constructor(){super(new B)}}class B{get(e){return localStorage.getItem(e)}set(e,t){localStorage.setItem(e,t)}remove(e){localStorage.removeItem(e)}}class j extends L{constructor(){super(new N)}}class N{cache=new Map;get(e){return this.cache.get(e)??null}set(e,t){this.cache.set(e,t)}remove(e){this.cache.delete(e)}}class M{clientId;accessToken;refreshTokenAction;constructor(e,t,s){this.clientId=e,this.accessToken=t,this.refreshTokenAction=s||q.refreshCachedAccessToken,this.accessToken.expires||(this.accessToken.expires=q.calculateExpiry(this.accessToken))}setConfiguration(e){}async getOrCreateAccessToken(){if(this.accessToken.expires&&this.accessToken.expires<=Date.now()){const e=await this.refreshTokenAction(this.clientId,this.accessToken);this.accessToken=e}return this.accessToken}async getAccessToken(){return this.accessToken}removeAccessToken(){this.accessToken={access_token:"",token_type:"",expires_in:0,refresh_token:"",expires:0}}}class H{sdkConfig;static rootUrl="https://api.spotify.com/v1/";authenticationStrategy;albums;artists;audiobooks;browse;chapters;episodes;recommendations;markets;player;playlists;shows;tracks;users;search;currentUser;constructor(e,t){this.sdkConfig=this.initializeSdk(t),this.albums=new r(this),this.artists=new i(this),this.audiobooks=new a(this),this.browse=new o(this),this.chapters=new c(this),this.episodes=new u(this),this.recommendations=new h(this),this.markets=new l(this),this.player=new p(this),this.playlists=new d(this),this.shows=new y(this),this.tracks=new m(this),this.users=new v(this),this.currentUser=new k(this);const s=new f(this);this.search=s.execute.bind(s),this.authenticationStrategy=e,this.authenticationStrategy.setConfiguration(this.sdkConfig)}async makeRequest(e,t,s=void 0,n=void 0){try{const r=await this.authenticationStrategy.getOrCreateAccessToken();if(w(r))return console.warn("No access token found, authenticating now."),null;const i=r?.access_token,a=H.rootUrl+t,o={method:e,headers:{Authorization:`Bearer ${i}`,"Content-Type":n??"application/json"},body:s?"string"==typeof s?s:JSON.stringify(s):void 0};this.sdkConfig.beforeRequest(a,o);const c=await this.sdkConfig.fetch(a,o);return this.sdkConfig.afterRequest(a,o,c),204===c.status?null:(await this.sdkConfig.responseValidator.validateResponse(c),this.sdkConfig.deserializer.deserialize(c))}catch(e){if(!await this.sdkConfig.errorHandler.handleErrors(e))throw e;return null}}initializeSdk(e){const t="undefined"!=typeof window;return{...{fetch:(e,t)=>fetch(e,t),beforeRequest:(e,t)=>{},afterRequest:(e,t,s)=>{},deserializer:new F,responseValidator:new E,errorHandler:new U,redirectionStrategy:new P,cachingStrategy:t?new O:new j},...e}}switchAuthenticationStrategy(e){this.authenticationStrategy=e,this.authenticationStrategy.setConfiguration(this.sdkConfig),this.authenticationStrategy.getOrCreateAccessToken()}async authenticate(){const e=await this.authenticationStrategy.getOrCreateAccessToken();return{authenticated:e.expires>Date.now()&&!w(e),accessToken:e}}async getAccessToken(){return this.authenticationStrategy.getAccessToken()}logOut(){this.authenticationStrategy.removeAccessToken()}static withUserAuthorization(e,t,s=[],n){const r=new $(e,t,s);return new H(r,n)}static withClientCredentials(e,t,s=[],n){const r=new A(e,t,s);return new H(r,n)}static withImplicitGrant(e,t,s=[],n){const r=new I(e,t,s);return new H(r,n)}static withAccessToken(e,t,s){const n=new M(e,t);return new H(n,s)}static async performUserAuthorization(e,t,s,n,r){const i=new $(e,t,s),a=new H(i,r),o=await a.authenticationStrategy.getOrCreateAccessToken();return w(o)||("string"==typeof n?(console.log("Posting access token to postback URL."),await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})):await n(o)),{authenticated:o.expires>Date.now()&&!w(o),accessToken:o}}}var D="undefined"!=typeof Buffer&&Buffer.from?function(e){return Buffer.from(e,"utf8")}:e=>(new TextEncoder).encode(e);function z(e){return e instanceof Uint8Array?e:"string"==typeof e?D(e):ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength/Uint8Array.BYTES_PER_ELEMENT):new Uint8Array(e)}function K(e){return"string"==typeof e?0===e.length:0===e.byteLength}var V={name:"SHA-256"},J={name:"HMAC",hash:V},W=new Uint8Array([227,176,196,66,152,252,28,20,154,251,244,200,153,111,185,36,39,174,65,228,100,155,147,76,164,149,153,27,120,82,184,85]);const G={};function Q(){return"undefined"!=typeof window?window:"undefined"!=typeof self?self:G}var Y=function(){function e(e){this.toHash=new Uint8Array(0),this.secret=e,this.reset()}return e.prototype.update=function(e){if(!K(e)){var t=z(e),s=new Uint8Array(this.toHash.byteLength+t.byteLength);s.set(this.toHash,0),s.set(t,this.toHash.byteLength),this.toHash=s}},e.prototype.digest=function(){var e=this;return this.key?this.key.then((function(t){return Q().crypto.subtle.sign(J,t,e.toHash).then((function(e){return new Uint8Array(e)}))})):K(this.toHash)?Promise.resolve(W):Promise.resolve().then((function(){return Q().crypto.subtle.digest(V,e.toHash)})).then((function(e){return Promise.resolve(new Uint8Array(e))}))},e.prototype.reset=function(){var e=this;this.toHash=new Uint8Array(0),this.secret&&void 0!==this.secret&&(this.key=new Promise((function(t,s){Q().crypto.subtle.importKey("raw",z(e.secret),J,!1,["sign"]).then(t,s)})),this.key.catch((function(){})))},e}();function X(e,t,s,n){return new(s||(s=Promise))((function(r,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function o(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,o)}c((n=n.apply(e,t||[])).next())}))}function Z(e,t){var s,n,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(c){return function(o){if(s)throw new TypeError("Generator is already executing.");for(;a&&(a=0,o[0]&&(i=0)),i;)try{if(s=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,n=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){i.label=o[1];break}if(6===o[0]&&i.label<r[1]){i.label=r[1],r=o;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(o);break}r[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],n=0}finally{s=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}}Object.create;Object.create;"function"==typeof SuppressedError&&SuppressedError;var ee=64,te=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),se=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],ne=Math.pow(2,53)-1,re=function(){function e(){this.state=Int32Array.from(se),this.temp=new Int32Array(64),this.buffer=new Uint8Array(64),this.bufferLength=0,this.bytesHashed=0,this.finished=!1}return e.prototype.update=function(e){if(this.finished)throw new Error("Attempted to update an already finished hash.");var t=0,s=e.byteLength;if(this.bytesHashed+=s,8*this.bytesHashed>ne)throw new Error("Cannot hash more than 2^53 - 1 bits");for(;s>0;)this.buffer[this.bufferLength++]=e[t++],s--,this.bufferLength===ee&&(this.hashBuffer(),this.bufferLength=0)},e.prototype.digest=function(){if(!this.finished){var e=8*this.bytesHashed,t=new DataView(this.buffer.buffer,this.buffer.byteOffset,this.buffer.byteLength),s=this.bufferLength;if(t.setUint8(this.bufferLength++,128),s%ee>=56){for(var n=this.bufferLength;n<ee;n++)t.setUint8(n,0);this.hashBuffer(),this.bufferLength=0}for(n=this.bufferLength;n<56;n++)t.setUint8(n,0);t.setUint32(56,Math.floor(e/4294967296),!0),t.setUint32(60,e),this.hashBuffer(),this.finished=!0}var r=new Uint8Array(32);for(n=0;n<8;n++)r[4*n]=this.state[n]>>>24&255,r[4*n+1]=this.state[n]>>>16&255,r[4*n+2]=this.state[n]>>>8&255,r[4*n+3]=this.state[n]>>>0&255;return r},e.prototype.hashBuffer=function(){for(var e=this.buffer,t=this.state,s=t[0],n=t[1],r=t[2],i=t[3],a=t[4],o=t[5],c=t[6],u=t[7],h=0;h<ee;h++){if(h<16)this.temp[h]=(255&e[4*h])<<24|(255&e[4*h+1])<<16|(255&e[4*h+2])<<8|255&e[4*h+3];else{var l=this.temp[h-2],p=(l>>>17|l<<15)^(l>>>19|l<<13)^l>>>10,d=((l=this.temp[h-15])>>>7|l<<25)^(l>>>18|l<<14)^l>>>3;this.temp[h]=(p+this.temp[h-7]|0)+(d+this.temp[h-16]|0)}var f=(((a>>>6|a<<26)^(a>>>11|a<<21)^(a>>>25|a<<7))+(a&o^~a&c)|0)+(u+(te[h]+this.temp[h]|0)|0)|0,y=((s>>>2|s<<30)^(s>>>13|s<<19)^(s>>>22|s<<10))+(s&n^s&r^n&r)|0;u=c,c=o,o=a,a=i+f|0,i=r,r=n,n=s,s=f+y|0}t[0]+=s,t[1]+=n,t[2]+=r,t[3]+=i,t[4]+=a,t[5]+=o,t[6]+=c,t[7]+=u},e}(),ie=function(){function e(e){this.secret=e,this.hash=new re,this.reset()}return e.prototype.update=function(e){if(!K(e)&&!this.error)try{this.hash.update(z(e))}catch(e){this.error=e}},e.prototype.digestSync=function(){if(this.error)throw this.error;return this.outer?(this.outer.finished||this.outer.update(this.hash.digest()),this.outer.digest()):this.hash.digest()},e.prototype.digest=function(){return X(this,void 0,void 0,(function(){return Z(this,(function(e){return[2,this.digestSync()]}))}))},e.prototype.reset=function(){if(this.hash=new re,this.secret){this.outer=new re;var e=function(e){var t=z(e);if(t.byteLength>ee){var s=new re;s.update(t),t=s.digest()}var n=new Uint8Array(ee);return n.set(t),n}(this.secret),t=new Uint8Array(ee);t.set(e);for(var s=0;s<ee;s++)e[s]^=54,t[s]^=92;this.hash.update(e),this.outer.update(t);for(s=0;s<e.byteLength;s++)e[s]=0}},e}();var ae=["decrypt","digest","encrypt","exportKey","generateKey","importKey","sign","verify"];function oe(e){return e&&ae.every((function(t){return"function"==typeof e[t]}))}var ce,ue,he=function(){function e(e){!function(e){return!(!function(e){return"object"==typeof e&&"object"==typeof e.crypto&&"function"==typeof e.crypto.getRandomValues}(e)||"object"!=typeof e.crypto.subtle)&&oe(e.crypto.subtle)}(Q())?this.hash=new ie(e):this.hash=new Y(e)}return e.prototype.update=function(e,t){this.hash.update(z(e))},e.prototype.digest=function(){return this.hash.digest()},e.prototype.reset=function(){this.hash.reset()},e}();!function(e){e[e.None=-1]="None",e[e.AfterPrompt=0]="AfterPrompt",e[e.InChat=1]="InChat",e[e.BeforePrompt=2]="BeforePrompt"}(ce||(ce={})),function(e){e[e.System=0]="System",e[e.User=1]="User",e[e.Assistant=2]="Assistant"}(ue||(ue={}));const le="spotify",pe="spotify_inject",de="spotify_verifier",fe=["user-read-private","user-read-playback-state"];var ye=s(72),me=s.n(ye),ge=s(825),we=s.n(ge),ve=s(659),ke=s.n(ve),be=s(56),Se=s.n(be),Re=s(540),_e=s.n(Re),Te=s(113),xe=s.n(Te),Ce=s(208),qe={};qe.styleTagTransform=xe(),qe.setAttributes=Se(),qe.insert=ke().bind(null,"head"),qe.domAPI=we(),qe.insertStyleElement=_e();me()(Ce.A,qe);Ce.A&&Ce.A.locals&&Ce.A.locals;var Ae=function(e,t,s,n){return new(s||(s=Promise))((function(r,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function o(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,o)}c((n=n.apply(e,t||[])).next())}))};const{extensionSettings:Ie,saveSettingsDebounced:$e,setExtensionPrompt:Fe,substituteParamsExtended:Ee,t:Ue}=SillyTavern.getContext(),Pe=Object.freeze({clientId:"",clientToken:null,template:"[{{user}} is listening to {{song}} by {{artist}} on Spotify]",position:ce.InChat,role:ue.System,depth:1,scan:!0});function Le(){const e=Ie;e[le]||(e[le]=structuredClone(Pe));for(const t in Pe)void 0===e[le][t]&&(e[le][t]=Pe[t]);return e[le]}function Oe(e){var t;const s=null!==(t=document.getElementById("spotify_container"))&&void 0!==t?t:document.getElementById("extensions_settings2");if(!s)return;const n=document.createElement("template");n.innerHTML='<div id="spotify_settings"> <div class="inline-drawer"> <div class="inline-drawer-toggle inline-drawer-header"> <b> <span>Spotify</span> </b> <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div> </div> <div class="inline-drawer-content"> <div> <label for="spotify_client_id">Client ID</label> <input type="text" id="spotify_client_id" class="text_pole" placeholder="Spotify Client ID"/> </div> <div> <span>Logged in as:</span> <b id="spotify_user_name"></b> </div> <div class="flex-container"> <div id="spotify_auth" class="menu_button menu_button_icon"> <div class="fa-brands fa-spotify"></div> <span data-i18n="Authenticate">Authenticate</span> </div> <div id="spotify_logout" class="menu_button menu_button_icon"> <div class="fa-solid fa-right-from-bracket"></div> <span data-i18n="Logout">Logout</span> </div> </div> <div> <label for="spotify_template">Injection Template</label> <textarea id="spotify_template" class="text_pole textarea_compact" rows="2"></textarea> </div> <div> <label class="checkbox_label" for="spotify_scan"> <input id="spotify_scan" type="checkbox"/> <span>Include in World Info Scanning</span> </label> </div> <div> <label for="spotify_position">Injection Position</label> <div class="radio_group"> <label> <input type="radio" name="spotify_position" value="-1"/> <span data-i18n="None (not injected)">None (not injected)</span> </label> <label> <input type="radio" name="spotify_position" value="2"/> <span data-i18n="Before Main Prompt / Story String">Before Main Prompt / Story String</span> </label> <label> <input type="radio" name="spotify_position" value="0"/> <span data-i18n="After Main Prompt / Story String">After Main Prompt / Story String</span> </label> <label class="flex-container alignItemsCenter" title="How many messages before the current end of the chat." data-i18n="[title]How many messages before the current end of the chat."> <input type="radio" name="spotify_position" value="1"/> <span data-i18n="In-chat @ Depth">In-chat @ Depth</span> <input id="spotify_depth" class="text_pole widthUnset" type="number" min="0" max="999"/> <span data-i18n="as">as</span> <select id="spotify_role" class="text_pole widthNatural"> <option value="0" data-i18n="System">System</option> <option value="1" data-i18n="User">User</option> <option value="2" data-i18n="Assistant">Assistant</option> </select> </label> </div> </div> </div> </div> </div> ',s.appendChild(n.content);const r={clientId:document.getElementById("spotify_client_id"),template:document.getElementById("spotify_template"),role:document.getElementById("spotify_role"),position:Array.from(document.getElementsByName("spotify_position")),depth:document.getElementById("spotify_depth"),scan:document.getElementById("spotify_scan"),authButton:document.getElementById("spotify_auth"),logoutButton:document.getElementById("spotify_logout")};r.clientId.value=e.clientId,r.template.value=e.template,r.role.value=e.role.toString(),r.position.forEach((t=>{t.checked=e.position===parseInt(t.value)})),r.depth.value=e.depth.toString(),r.scan.checked=e.scan;const i=(t,s,n)=>{t.addEventListener("input",(()=>{const r=t instanceof HTMLInputElement&&"checkbox"===t.type?t.checked:t.value;e[s]=n?n(r):r,$e()}))};i(r.clientId,"clientId"),i(r.template,"template"),i(r.role,"role",(e=>parseInt(e))),i(r.depth,"depth",(e=>parseInt(e))),i(r.scan,"scan"),r.position.forEach((t=>{t.addEventListener("input",(t=>{e.position=parseInt(t.target.value),$e()}))})),r.authButton.addEventListener("click",(()=>{!function(){Ae(this,void 0,void 0,(function*(){const e=Le();if(!e.clientId)return void toastr.error(Ue`Please enter your Spotify Client ID in the settings.`);const t=function(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return crypto.getRandomValues(new Uint8Array(e)).reduce(((e,s)=>e+t[s%62]),"")}(64),s=yield function(e){const t=(new TextEncoder).encode(e),s=new he;return s.update(t),s.digest()}(t),n=(r=s,btoa(String.fromCharCode(...new Uint8Array(r))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"));var r;const i=new URL("/callback/spotify",location.origin),a={response_type:"code",client_id:e.clientId,scope:fe.join(" "),redirect_uri:i.toString(),code_challenge_method:"S256",code_challenge:n};sessionStorage.setItem(de,t);const o=new URL("https://accounts.spotify.com/authorize");o.search=new URLSearchParams(a).toString(),window.location.href=o.toString()}))}()})),r.logoutButton.addEventListener("click",(()=>{e.clientToken=null,Be(Ue`[Not logged in]`),$e()}))}function Be(e){const t=document.getElementById("spotify_user_name");t&&(t.innerText=e)}function je(e){return Ae(this,void 0,void 0,(function*(){const t=function(){const e=new URLSearchParams(window.location.search);if("spotify"!==e.get("source"))return null;const t=e.get("query");if(t){const e=new URLSearchParams(t).get("code");return window.history.replaceState({},document.title,window.location.pathname),e}return null}(),s=sessionStorage.getItem(de);if(!t||!s||!e.clientId)return;const n=new URL("/callback/spotify",window.location.origin),r={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:e.clientId,grant_type:"authorization_code",redirect_uri:n.toString(),code_verifier:s,code:t})};try{const t=yield fetch("https://accounts.spotify.com/api/token",r),s=yield t.json();e.clientToken=s,sessionStorage.removeItem(de),$e(),console.log("Spotify token received:",s),toastr.success(Ue`Successfully authenticated with Spotify!`)}catch(e){console.error("Error during Spotify authentication:",e),toastr.error(Ue`Spotify authentication failed. Please try again.`)}}))}function Ne(e){return Ae(this,void 0,void 0,(function*(){if(!e.clientToken||!e.clientId)return;const t=e.clientToken.expires,s=e.clientToken.refresh_token,n=Date.now();if(t&&t-n<3e5){const t="https://accounts.spotify.com/api/token",n={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:s,client_id:e.clientId})};try{const r=yield fetch(t,n),i=yield r.json();e.clientToken=i,e.clientToken&&!i.refresh_token&&(e.clientToken.refresh_token=s),console.log("Spotify token refreshed:",i),$e()}catch(e){console.error("Error refreshing Spotify token:",e)}}}))}function Me(){return Ae(this,void 0,void 0,(function*(){Fe(pe,"",ce.None,0);const e=Le();if(e.clientToken&&e.clientId&&e.template)try{yield Ne(e);const t=H.withAccessToken(e.clientId,e.clientToken),s=yield t.player.getCurrentlyPlayingTrack();console.log("Currently playing Spotify track:",s);const n=function(e){var t;if(!e)return{};switch(e.type){case"track":{const s=e;return{song:s.name,artist:null===(t=s.artists.map((e=>e.name)))||void 0===t?void 0:t.join(", "),album:s.album.name,year:s.album.release_date.split("-")[0]}}case"show":{const t=e;return{song:t.name,artist:t.show.name}}}return{}}(s.item),r=Ee(e.template,n);Fe(pe,r,e.position,e.depth,e.scan,e.role)}catch(e){console.error("Error fetching currently playing track:",e)}}))}!function(){Ae(this,void 0,void 0,(function*(){const e=Le();Oe(e),yield je(e),yield Ne(e),yield function(e){return Ae(this,void 0,void 0,(function*(){if(e.clientToken&&e.clientId)try{const t=H.withAccessToken(e.clientId,e.clientToken),s=yield t.currentUser.profile();Be(s.display_name||s.id)}catch(t){console.error("Error fetching user data:",t),e.clientToken=null,Be("[Token expired]")}else Be(Ue`[Not logged in]`)}))}(e),globalThis.spotify_setCurrentTrack=Me,$e()}))}()})();