(()=>{"use strict";var e={208:(e,t,s)=>{s.d(t,{A:()=>o});var r=s(601),n=s.n(r),i=s(314),a=s.n(i)()(n());a.push([e.id,"#spotify_template {\n    field-sizing: content;\n}\n",""]);const o=a},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var s="",r=void 0!==t[5];return t[4]&&(s+="@supports (".concat(t[4],") {")),t[2]&&(s+="@media ".concat(t[2]," {")),r&&(s+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),s+=e(t),r&&(s+="}"),t[2]&&(s+="}"),t[4]&&(s+="}"),s})).join("")},t.i=function(e,s,r,n,i){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(r)for(var o=0;o<this.length;o++){var c=this[o][0];null!=c&&(a[c]=!0)}for(var l=0;l<e.length;l++){var u=[].concat(e[l]);r&&a[u[0]]||(void 0!==i&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=i),s&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=s):u[2]=s),n&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=n):u[4]="".concat(n)),t.push(u))}},t}},601:e=>{e.exports=function(e){return e[1]}},72:e=>{var t=[];function s(e){for(var s=-1,r=0;r<t.length;r++)if(t[r].identifier===e){s=r;break}return s}function r(e,r){for(var i={},a=[],o=0;o<e.length;o++){var c=e[o],l=r.base?c[0]+r.base:c[0],u=i[l]||0,h="".concat(l," ").concat(u);i[l]=u+1;var p=s(h),d={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==p)t[p].references++,t[p].updater(d);else{var y=n(d,r);r.byIndex=o,t.splice(o,0,{identifier:h,updater:y,references:1})}a.push(h)}return a}function n(e,t){var s=t.domAPI(t);s.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;s.update(e=t)}else s.remove()}}e.exports=function(e,n){var i=r(e=e||[],n=n||{});return function(e){e=e||[];for(var a=0;a<i.length;a++){var o=s(i[a]);t[o].references--}for(var c=r(e,n),l=0;l<i.length;l++){var u=s(i[l]);0===t[u].references&&(t[u].updater(),t.splice(u,1))}i=c}}},659:e=>{var t={};e.exports=function(e,s){var r=function(e){if(void 0===t[e]){var s=document.querySelector(e);if(window.HTMLIFrameElement&&s instanceof window.HTMLIFrameElement)try{s=s.contentDocument.head}catch(e){s=null}t[e]=s}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(s)}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56:(e,t,s)=>{e.exports=function(e){var t=s.nc;t&&e.setAttribute("nonce",t)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(s){!function(e,t,s){var r="";s.supports&&(r+="@supports (".concat(s.supports,") {")),s.media&&(r+="@media ".concat(s.media," {"));var n=void 0!==s.layer;n&&(r+="@layer".concat(s.layer.length>0?" ".concat(s.layer):""," {")),r+=s.css,n&&(r+="}"),s.media&&(r+="}"),s.supports&&(r+="}");var i=s.sourceMap;i&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,s)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}},t={};function s(r){var n=t[r];if(void 0!==n)return n.exports;var i=t[r]={id:r,exports:{}};return e[r](i,i.exports,s),i.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.nc=void 0;class r{api;constructor(e){this.api=e}async getRequest(e){return await this.api.makeRequest("GET",e)}async postRequest(e,t,s=void 0){return await this.api.makeRequest("POST",e,t,s)}async putRequest(e,t,s=void 0){return await this.api.makeRequest("PUT",e,t,s)}async deleteRequest(e,t){return await this.api.makeRequest("DELETE",e,t)}paramsFor(e){const t=new URLSearchParams;for(let s of Object.getOwnPropertyNames(e))(e[s]||0===e[s]||!e[s]&&"boolean"==typeof e[s])&&t.append(s,e[s].toString());return[...t].length>0?`?${t.toString()}`:""}}class n extends r{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return await this.getRequest(`albums/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`albums${s}`)).albums}tracks(e,t,s,r){const n=this.paramsFor({market:t,limit:s,offset:r});return this.getRequest(`albums/${e}/tracks${n}`)}}class i extends r{async get(e){if("string"==typeof e){return this.getRequest(`artists/${e}`)}const t=this.paramsFor({ids:e});return(await this.getRequest(`artists${t}`)).artists}albums(e,t,s,r,n){const i=this.paramsFor({include_groups:t,market:s,limit:r,offset:n});return this.getRequest(`artists/${e}/albums${i}`)}topTracks(e,t){const s=this.paramsFor({market:t});return this.getRequest(`artists/${e}/top-tracks${s}`)}relatedArtists(e){return this.getRequest(`artists/${e}/related-artists`)}}class a extends r{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`audiobooks/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`audiobooks${s}`)).audiobooks}getAudiobookChapters(e,t,s,r){const n=this.paramsFor({market:t,limit:s,offset:r});return this.getRequest(`audiobooks/${e}/chapters${n}`)}}class o extends r{getCategories(e,t,s,r){const n=this.paramsFor({country:e,locale:t,limit:s,offset:r});return this.getRequest(`browse/categories${n}`)}getCategory(e,t,s){const r=this.paramsFor({country:t,locale:s});return this.getRequest(`browse/categories/${e}${r}`)}getNewReleases(e,t,s){const r=this.paramsFor({country:e,limit:t,offset:s});return this.getRequest(`browse/new-releases${r}`)}getFeaturedPlaylists(e,t,s,r,n){const i=this.paramsFor({country:e,locale:t,timestamp:s,limit:r,offset:n});return this.getRequest(`browse/featured-playlists${i}`)}getPlaylistsForCategory(e,t,s,r){const n=this.paramsFor({country:t,limit:s,offset:r});return this.getRequest(`browse/categories/${e}/playlists${n}`)}}class c extends r{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`chapters/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`chapters${s}`)).chapters}}class l extends r{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`episodes/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`episodes${s}`)).episodes}}class u extends r{get(e){const t=this.paramsFor(e);return this.getRequest(`recommendations${t}`)}genreSeeds(){return this.getRequest("recommendations/available-genre-seeds")}}class h extends r{getAvailableMarkets(){return this.getRequest("markets")}}class p extends r{getPlaybackState(e,t){const s=this.paramsFor({market:e,additional_types:t});return this.getRequest(`me/player${s}`)}getAvailableDevices(){return this.getRequest("me/player/devices")}getCurrentlyPlayingTrack(e,t){const s=this.paramsFor({market:e,additional_types:t});return this.getRequest(`me/player/currently-playing${s}`)}getRecentlyPlayedTracks(e,t){const s={limit:e};t&&("before"===t.type?s.before=t.timestamp:"after"===t.type&&(s.after=t.timestamp));const r=this.paramsFor(s);return this.getRequest(`me/player/recently-played${r}`)}getUsersQueue(){return this.getRequest("me/player/queue")}async transferPlayback(e,t){if(e.length>1)throw new Error("Although an array is accepted, only a single device_id is currently supported. Supplying more than one will return 400 Bad Request");await this.putRequest("me/player",{device_ids:e,play:t})}async startResumePlayback(e,t,s,r,n){const i=this.paramsFor({device_id:e});await this.putRequest(`me/player/play${i}`,{context_uri:t,uris:s,offset:r,positionMs:n})}async pausePlayback(e){const t=this.paramsFor({device_id:e});await this.putRequest(`me/player/pause${t}`)}async skipToNext(e){const t=this.paramsFor({device_id:e});await this.postRequest(`me/player/next${t}`)}async skipToPrevious(e){const t=this.paramsFor({device_id:e});await this.postRequest(`me/player/previous${t}`)}async seekToPosition(e,t){const s=this.paramsFor({position_ms:e,device_id:t});await this.putRequest(`me/player/seek${s}`)}async setRepeatMode(e,t){const s=this.paramsFor({state:e,device_id:t});await this.putRequest(`me/player/repeat${s}`)}async setPlaybackVolume(e,t){const s=this.paramsFor({volume_percent:e,device_id:t});await this.putRequest(`me/player/volume${s}`)}async togglePlaybackShuffle(e,t){const s=this.paramsFor({state:e,device_id:t});await this.putRequest(`me/player/shuffle${s}`)}async addItemToPlaybackQueue(e,t){const s=this.paramsFor({uri:e,device_id:t});await this.postRequest(`me/player/queue${s}`)}}class d extends r{getPlaylist(e,t,s,r){const n=this.paramsFor({market:t,fields:s,additional_types:r?.join(",")});return this.getRequest(`playlists/${e}${n}`)}getPlaylistItems(e,t,s,r,n,i){const a=this.paramsFor({market:t,fields:s,limit:r,offset:n,additional_types:i?.join(",")});return this.getRequest(`playlists/${e}/tracks${a}`)}async changePlaylistDetails(e,t){await this.putRequest(`playlists/${e}`,t)}movePlaylistItems(e,t,s,r){return this.updatePlaylistItems(e,{range_start:t,range_length:s,insert_before:r})}updatePlaylistItems(e,t){return this.putRequest(`playlists/${e}/tracks`,t)}async addItemsToPlaylist(e,t,s){await this.postRequest(`playlists/${e}/tracks`,{position:s,uris:t})}async removeItemsFromPlaylist(e,t){await this.deleteRequest(`playlists/${e}/tracks`,t)}getUsersPlaylists(e,t,s){const r=this.paramsFor({limit:t,offset:s});return this.getRequest(`users/${e}/playlists${r}`)}createPlaylist(e,t){return this.postRequest(`users/${e}/playlists`,t)}getPlaylistCoverImage(e){return this.getRequest(`playlists/${e}/images`)}async addCustomPlaylistCoverImage(e,t){let s="";if(t instanceof Buffer)s=t.toString("base64");else if(t instanceof HTMLCanvasElement)s=t.toDataURL("image/jpeg").split(";base64,")[1];else if(t instanceof HTMLImageElement){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const r=e.getContext("2d");if(!r)throw new Error("Could not get canvas context");r.drawImage(t,0,0),s=e.toDataURL("image/jpeg").split(";base64,")[1]}else{if("string"!=typeof t)throw new Error("ImageData must be a Buffer, HTMLImageElement, HTMLCanvasElement, or string containing a base64 encoded jpeg");s=t}await this.addCustomPlaylistCoverImageFromBase64String(e,s)}async addCustomPlaylistCoverImageFromBase64String(e,t){await this.putRequest(`playlists/${e}/images`,t,"image/jpeg")}}class y extends r{async execute(e,t,s,r,n,i){const a=this.paramsFor({q:e,type:t,market:s,limit:r,offset:n,include_external:i});return await this.getRequest(`search${a}`)}}class f extends r{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`shows/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`shows${s}`)).shows}episodes(e,t,s,r){const n=this.paramsFor({market:t,limit:s,offset:r});return this.getRequest(`shows/${e}/episodes${n}`)}}class m extends r{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`tracks/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`tracks${s}`)).tracks}async audioFeatures(e){if("string"==typeof e)return this.getRequest(`audio-features/${e}`);const t=this.paramsFor({ids:e});return(await this.getRequest(`audio-features${t}`)).audio_features}audioAnalysis(e){return this.getRequest(`audio-analysis/${e}`)}}const g={access_token:"emptyAccessToken",token_type:"",expires_in:0,refresh_token:"",expires:-1};function k(e){return e===g}class w extends r{profile(e){return this.getRequest(`users/${e}`)}}class v extends r{albums;audiobooks;episodes;playlists;shows;tracks;constructor(e){super(e),this.albums=new b(e),this.audiobooks=new T(e),this.episodes=new _(e),this.playlists=new S(e),this.shows=new R(e),this.tracks=new x(e)}profile(){return this.getRequest("me")}topItems(e,t,s,r){const n=this.paramsFor({time_range:t,limit:s,offset:r});return this.getRequest(`me/top/${e}${n}`)}followedArtists(e,t){const s=this.paramsFor({type:"artist",after:e,limit:t});return this.getRequest(`me/following${s}`)}async followArtistsOrUsers(e,t){const s=this.paramsFor({type:t});await this.putRequest(`me/following${s}`,{ids:e})}async unfollowArtistsOrUsers(e,t){const s=this.paramsFor({type:t});await this.deleteRequest(`me/following${s}`,{ids:e})}followsArtistsOrUsers(e,t){const s=this.paramsFor({ids:e,type:t});return this.getRequest(`me/following/contains${s}`)}}class b extends r{savedAlbums(e,t,s){const r=this.paramsFor({limit:e,offset:t,market:s});return this.getRequest(`me/albums${r}`)}async saveAlbums(e){await this.putRequest("me/albums",e)}async removeSavedAlbums(e){await this.deleteRequest("me/albums",e)}hasSavedAlbums(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/albums/contains${t}`)}}class T extends r{savedAudiobooks(e,t){const s=this.paramsFor({limit:e,offset:t});return this.getRequest(`me/audiobooks${s}`)}async saveAudiobooks(e){await this.putRequest("me/audiobooks",e)}async removeSavedAudiobooks(e){await this.deleteRequest("me/audiobooks",e)}hasSavedAudiobooks(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/audiobooks/contains${t}`)}}class _ extends r{savedEpisodes(e,t,s){const r=this.paramsFor({market:e,limit:t,offset:s});return this.getRequest(`me/episodes${r}`)}async saveEpisodes(e){await this.putRequest("me/episodes",e)}async removeSavedEpisodes(e){await this.deleteRequest("me/episodes",e)}hasSavedEpisodes(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/episodes/contains${t}`)}}class S extends r{playlists(e,t){const s=this.paramsFor({limit:e,offset:t});return this.getRequest(`me/playlists${s}`)}async follow(e){await this.putRequest(`playlists/${e}/followers`)}async unfollow(e){await this.deleteRequest(`playlists/${e}/followers`)}isFollowing(e,t){const s=this.paramsFor({ids:t});return this.getRequest(`playlists/${e}/followers/contains${s}`)}}class R extends r{savedShows(e,t){const s=this.paramsFor({limit:e,offset:t});return this.getRequest(`me/shows${s}`)}saveShows(e){const t=this.paramsFor({ids:e});return this.putRequest(`me/shows${t}`)}removeSavedShows(e,t){const s=this.paramsFor({ids:e,market:t});return this.deleteRequest(`me/shows${s}`)}hasSavedShow(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/shows/contains${t}`)}}class x extends r{savedTracks(e,t,s){const r=this.paramsFor({limit:e,offset:t,market:s});return this.getRequest(`me/tracks${r}`)}async saveTracks(e){await this.putRequest("me/tracks",e)}async removeSavedTracks(e){await this.deleteRequest("me/tracks",e)}hasSavedTracks(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/tracks/contains${t}`)}}class I{static get current(){return this.hasSubtleCrypto?window.crypto:this.tryLoadNodeWebCrypto()}static get hasSubtleCrypto(){return"undefined"!=typeof window&&void 0!==window.crypto&&void 0!==window.crypto.subtle}static tryLoadNodeWebCrypto(){try{const{webcrypto:e}=require("crypto");return e}catch(e){throw e}}}class C{static async refreshCachedAccessToken(e,t){const s=await C.refreshToken(e,t.refresh_token);return C.toCachable(s)}static toCachable(e){return e.expires&&-1===e.expires?e:{...e,expires:this.calculateExpiry(e)}}static calculateExpiry(e){return Date.now()+1e3*e.expires_in}static async refreshToken(e,t){const s=new URLSearchParams;s.append("client_id",e),s.append("grant_type","refresh_token"),s.append("refresh_token",t);const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s}),n=await r.text();if(!r.ok)throw new Error(`Failed to refresh token: ${r.statusText}, ${n}`);return JSON.parse(n)}static generateCodeVerifier(e){let t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let r=0;r<e;r++)t+=s.charAt(Math.floor(62*Math.random()));return t}static async generateCodeChallenge(e){const t=(new TextEncoder).encode(e),s=await I.current.subtle.digest("SHA-256",t),r=[...new Uint8Array(s)];return("undefined"!=typeof Buffer?Buffer.from(s).toString("base64"):btoa(String.fromCharCode.apply(null,r))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}}class q{clientId;clientSecret;scopes;static cacheKey="spotify-sdk:ClientCredentialsStrategy:token";configuration=null;get cache(){return this.configuration.cachingStrategy}constructor(e,t,s=[]){this.clientId=e,this.clientSecret=t,this.scopes=s}setConfiguration(e){this.configuration=e}async getOrCreateAccessToken(){return await this.cache.getOrCreate(q.cacheKey,(async()=>{const e=await this.getTokenFromApi();return C.toCachable(e)}),(async e=>{const t=await this.getTokenFromApi();return C.toCachable(t)}))}async getAccessToken(){return await this.cache.get(q.cacheKey)}removeAccessToken(){this.cache.remove(q.cacheKey)}async getTokenFromApi(){const e={grant_type:"client_credentials",scope:this.scopes.join(" ")},t=Object.keys(e).map((t=>t+"="+e[t])).join("&"),s="undefined"!=typeof Buffer,r=`${this.clientId}:${this.clientSecret}`,n=s?Buffer.from(r).toString("base64"):btoa(r),i=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${n}`},body:t});if(200!==i.status)throw new Error("Failed to get access token.");return await i.json()}}class P{clientId;redirectUri;scopes;static cacheKey="spotify-sdk:ImplicitGrantStrategy:token";configuration=null;get cache(){return this.configuration.cachingStrategy}constructor(e,t,s){this.clientId=e,this.redirectUri=t,this.scopes=s}setConfiguration(e){this.configuration=e}async getOrCreateAccessToken(){return await this.cache.getOrCreate(P.cacheKey,(async()=>{const e=await this.redirectOrVerifyToken();return C.toCachable(e)}),(async e=>C.refreshCachedAccessToken(this.clientId,e)))}async getAccessToken(){return await this.cache.get(P.cacheKey)}removeAccessToken(){this.cache.remove(P.cacheKey)}async redirectOrVerifyToken(){const e=new URLSearchParams(window.location.hash.substring(1)),t=e.get("access_token");if(t)return Promise.resolve({access_token:t,token_type:e.get("token_type")??"",expires_in:parseInt(e.get("expires_in")??"0"),refresh_token:e.get("refresh_token")??"",expires:Number(e.get("expires"))||0});var s=(this.scopes??[]).join(" ");const r=new URLSearchParams;r.append("client_id",this.clientId),r.append("response_type","token"),r.append("redirect_uri",this.redirectUri),r.append("scope",s);const n="https://accounts.spotify.com/authorize?"+r.toString();return this.configuration.redirectionStrategy.redirect(n),g}}class A{clientId;redirectUri;scopes;static cacheKey="spotify-sdk:AuthorizationCodeWithPKCEStrategy:token";configuration=null;get cache(){return this.configuration.cachingStrategy}constructor(e,t,s){this.clientId=e,this.redirectUri=t,this.scopes=s}setConfiguration(e){this.configuration=e}async getOrCreateAccessToken(){return await this.cache.getOrCreate(A.cacheKey,(async()=>{const e=await this.redirectOrVerifyToken();return C.toCachable(e)}),(async e=>C.refreshCachedAccessToken(this.clientId,e)))}async getAccessToken(){return await this.cache.get(A.cacheKey)}removeAccessToken(){this.cache.remove(A.cacheKey)}async redirectOrVerifyToken(){const e=new URLSearchParams(window.location.search).get("code");if(e){const t=await this.verifyAndExchangeCode(e);return this.removeCodeFromUrl(),t}return this.redirectToSpotify(),g}async redirectToSpotify(){const e=C.generateCodeVerifier(128),t=await C.generateCodeChallenge(e),s={verifier:e,expiresOnAccess:!0};this.cache.setCacheItem("spotify-sdk:verifier",s);const r=await this.generateRedirectUrlForUser(this.scopes,t);await this.configuration.redirectionStrategy.redirect(r)}async verifyAndExchangeCode(e){const t=await this.cache.get("spotify-sdk:verifier"),s=t?.verifier;if(!s)throw new Error("No verifier found in cache - can't validate query string callback parameters.");return await this.configuration.redirectionStrategy.onReturnFromRedirect(),await this.exchangeCodeForToken(e,s)}removeCodeFromUrl(){const e=new URL(window.location.href);e.searchParams.delete("code");const t=e.search?e.href:e.href.replace("?","");window.history.replaceState({},document.title,t)}async generateRedirectUrlForUser(e,t){const s=e.join(" "),r=new URLSearchParams;return r.append("client_id",this.clientId),r.append("response_type","code"),r.append("redirect_uri",this.redirectUri),r.append("scope",s),r.append("code_challenge_method","S256"),r.append("code_challenge",t),`https://accounts.spotify.com/authorize?${r.toString()}`}async exchangeCodeForToken(e,t){const s=new URLSearchParams;s.append("client_id",this.clientId),s.append("grant_type","authorization_code"),s.append("code",e),s.append("redirect_uri",this.redirectUri),s.append("code_verifier",t);const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s}),n=await r.text();if(!r.ok)throw new Error(`Failed to exchange code for token: ${r.statusText}, ${n}`);return JSON.parse(n)}}class ${async deserialize(e){const t=await e.text();if(t.length>0){return JSON.parse(t)}return null}}class E{async validateResponse(e){switch(e.status){case 401:throw new Error("Bad or expired token. This can happen if the user revoked a token or the access token has expired. You should re-authenticate the user.");case 403:const t=await e.text();throw new Error(`Bad OAuth request (wrong consumer key, bad nonce, expired timestamp...). Unfortunately, re-authenticating the user won't help here. Body: ${t}`);case 429:throw new Error("The app has exceeded its rate limits.");default:if(!e.status.toString().startsWith("20")){const t=await e.text();throw new Error(`Unrecognised response code: ${e.status} - ${e.statusText}. Body: ${t}`)}}}}class U{async handleErrors(e){return!1}}class F{async redirect(e){document.location=e.toString()}async onReturnFromRedirect(){}}class j{storage;updateFunctions;autoRenewInterval;autoRenewWindow;constructor(e,t=new Map,s=0,r=12e4){this.storage=e,this.updateFunctions=t,this.autoRenewInterval=s,this.autoRenewWindow=r,this.autoRenewInterval>0&&setInterval((()=>this.autoRenewRenewableItems()),this.autoRenewInterval)}async getOrCreate(e,t,s){s&&this.updateFunctions.set(e,s);const r=await this.get(e);if(r)return r;const n=await t();if(!n)throw new Error("Could not create cache item");return k(n)||this.setCacheItem(e,n),n}async get(e){let t=this.storage.get(e),s=t?JSON.parse(t):null;if(this.itemDueToExpire(s)&&this.updateFunctions.has(e)){const r=this.updateFunctions.get(e);await this.tryUpdateItem(e,s,r),t=this.storage.get(e),s=t?JSON.parse(t):null}return s?s.expires&&(-1===s.expires||s.expires<=Date.now())?(this.remove(e),null):s.expiresOnAccess&&!0===s.expiresOnAccess?(this.remove(e),s):s:null}set(e,t,s){const r={...t,expires:Date.now()+s};this.setCacheItem(e,r)}setCacheItem(e,t){const s=JSON.stringify(t);this.storage.set(e,s)}remove(e){this.storage.remove(e)}itemDueToExpire(e){return!!e&&(!!e.expires&&e.expires-Date.now()<this.autoRenewWindow)}async autoRenewRenewableItems(){this.updateFunctions.forEach((async(e,t)=>{const s=await this.get(t);s&&e&&this.itemDueToExpire(s)&&await this.tryUpdateItem(t,s,e)}))}async tryUpdateItem(e,t,s){try{const r=await s(t);r&&this.setCacheItem(e,r)}catch(e){console.error(e)}}}class O extends j{constructor(){super(new L)}}class L{get(e){return localStorage.getItem(e)}set(e,t){localStorage.setItem(e,t)}remove(e){localStorage.removeItem(e)}}class B extends j{constructor(){super(new N)}}class N{cache=new Map;get(e){return this.cache.get(e)??null}set(e,t){this.cache.set(e,t)}remove(e){this.cache.delete(e)}}class D{clientId;accessToken;refreshTokenAction;constructor(e,t,s){this.clientId=e,this.accessToken=t,this.refreshTokenAction=s||C.refreshCachedAccessToken,this.accessToken.expires||(this.accessToken.expires=C.calculateExpiry(this.accessToken))}setConfiguration(e){}async getOrCreateAccessToken(){if(this.accessToken.expires&&this.accessToken.expires<=Date.now()){const e=await this.refreshTokenAction(this.clientId,this.accessToken);this.accessToken=e}return this.accessToken}async getAccessToken(){return this.accessToken}removeAccessToken(){this.accessToken={access_token:"",token_type:"",expires_in:0,refresh_token:"",expires:0}}}class z{sdkConfig;static rootUrl="https://api.spotify.com/v1/";authenticationStrategy;albums;artists;audiobooks;browse;chapters;episodes;recommendations;markets;player;playlists;shows;tracks;users;search;currentUser;constructor(e,t){this.sdkConfig=this.initializeSdk(t),this.albums=new n(this),this.artists=new i(this),this.audiobooks=new a(this),this.browse=new o(this),this.chapters=new c(this),this.episodes=new l(this),this.recommendations=new u(this),this.markets=new h(this),this.player=new p(this),this.playlists=new d(this),this.shows=new f(this),this.tracks=new m(this),this.users=new w(this),this.currentUser=new v(this);const s=new y(this);this.search=s.execute.bind(s),this.authenticationStrategy=e,this.authenticationStrategy.setConfiguration(this.sdkConfig)}async makeRequest(e,t,s=void 0,r=void 0){try{const n=await this.authenticationStrategy.getOrCreateAccessToken();if(k(n))return console.warn("No access token found, authenticating now."),null;const i=n?.access_token,a=z.rootUrl+t,o={method:e,headers:{Authorization:`Bearer ${i}`,"Content-Type":r??"application/json"},body:s?"string"==typeof s?s:JSON.stringify(s):void 0};this.sdkConfig.beforeRequest(a,o);const c=await this.sdkConfig.fetch(a,o);return this.sdkConfig.afterRequest(a,o,c),204===c.status?null:(await this.sdkConfig.responseValidator.validateResponse(c),this.sdkConfig.deserializer.deserialize(c))}catch(e){if(!await this.sdkConfig.errorHandler.handleErrors(e))throw e;return null}}initializeSdk(e){const t="undefined"!=typeof window;return{...{fetch:(e,t)=>fetch(e,t),beforeRequest:(e,t)=>{},afterRequest:(e,t,s)=>{},deserializer:new $,responseValidator:new E,errorHandler:new U,redirectionStrategy:new F,cachingStrategy:t?new O:new B},...e}}switchAuthenticationStrategy(e){this.authenticationStrategy=e,this.authenticationStrategy.setConfiguration(this.sdkConfig),this.authenticationStrategy.getOrCreateAccessToken()}async authenticate(){const e=await this.authenticationStrategy.getOrCreateAccessToken();return{authenticated:e.expires>Date.now()&&!k(e),accessToken:e}}async getAccessToken(){return this.authenticationStrategy.getAccessToken()}logOut(){this.authenticationStrategy.removeAccessToken()}static withUserAuthorization(e,t,s=[],r){const n=new A(e,t,s);return new z(n,r)}static withClientCredentials(e,t,s=[],r){const n=new q(e,t,s);return new z(n,r)}static withImplicitGrant(e,t,s=[],r){const n=new P(e,t,s);return new z(n,r)}static withAccessToken(e,t,s){const r=new D(e,t);return new z(r,s)}static async performUserAuthorization(e,t,s,r,n){const i=new A(e,t,s),a=new z(i,n),o=await a.authenticationStrategy.getOrCreateAccessToken();return k(o)||("string"==typeof r?(console.log("Posting access token to postback URL."),await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})):await r(o)),{authenticated:o.expires>Date.now()&&!k(o),accessToken:o}}}var M,H;!function(e){e[e.None=-1]="None",e[e.AfterPrompt=0]="AfterPrompt",e[e.InChat=1]="InChat",e[e.BeforePrompt=2]="BeforePrompt"}(M||(M={})),function(e){e[e.System=0]="System",e[e.User=1]="User",e[e.Assistant=2]="Assistant"}(H||(H={}));const G="spotify",K="spotify_inject",V="spotify_verifier",J=["user-read-private","user-read-playback-state","user-top-read","user-modify-playback-state","playlist-read-private"];var W="undefined"!=typeof Buffer&&Buffer.from?function(e){return Buffer.from(e,"utf8")}:e=>(new TextEncoder).encode(e);function Q(e){return e instanceof Uint8Array?e:"string"==typeof e?W(e):ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength/Uint8Array.BYTES_PER_ELEMENT):new Uint8Array(e)}function Y(e){return"string"==typeof e?0===e.length:0===e.byteLength}var Z={name:"SHA-256"},X={name:"HMAC",hash:Z},ee=new Uint8Array([227,176,196,66,152,252,28,20,154,251,244,200,153,111,185,36,39,174,65,228,100,155,147,76,164,149,153,27,120,82,184,85]);const te={};function se(){return"undefined"!=typeof window?window:"undefined"!=typeof self?self:te}var re=function(){function e(e){this.toHash=new Uint8Array(0),this.secret=e,this.reset()}return e.prototype.update=function(e){if(!Y(e)){var t=Q(e),s=new Uint8Array(this.toHash.byteLength+t.byteLength);s.set(this.toHash,0),s.set(t,this.toHash.byteLength),this.toHash=s}},e.prototype.digest=function(){var e=this;return this.key?this.key.then((function(t){return se().crypto.subtle.sign(X,t,e.toHash).then((function(e){return new Uint8Array(e)}))})):Y(this.toHash)?Promise.resolve(ee):Promise.resolve().then((function(){return se().crypto.subtle.digest(Z,e.toHash)})).then((function(e){return Promise.resolve(new Uint8Array(e))}))},e.prototype.reset=function(){var e=this;this.toHash=new Uint8Array(0),this.secret&&void 0!==this.secret&&(this.key=new Promise((function(t,s){se().crypto.subtle.importKey("raw",Q(e.secret),X,!1,["sign"]).then(t,s)})),this.key.catch((function(){})))},e}();function ne(e,t,s,r){return new(s||(s=Promise))((function(n,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))}function ie(e,t){var s,r,n,i={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(c){return function(o){if(s)throw new TypeError("Generator is already executing.");for(;a&&(a=0,o[0]&&(i=0)),i;)try{if(s=1,r&&(n=2&o[0]?r.return:o[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(n=i.trys,(n=n.length>0&&n[n.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){i.label=o[1];break}if(6===o[0]&&i.label<n[1]){i.label=n[1],n=o;break}if(n&&i.label<n[2]){i.label=n[2],i.ops.push(o);break}n[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{s=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}}Object.create;Object.create;"function"==typeof SuppressedError&&SuppressedError;var ae=64,oe=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ce=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],le=Math.pow(2,53)-1,ue=function(){function e(){this.state=Int32Array.from(ce),this.temp=new Int32Array(64),this.buffer=new Uint8Array(64),this.bufferLength=0,this.bytesHashed=0,this.finished=!1}return e.prototype.update=function(e){if(this.finished)throw new Error("Attempted to update an already finished hash.");var t=0,s=e.byteLength;if(this.bytesHashed+=s,8*this.bytesHashed>le)throw new Error("Cannot hash more than 2^53 - 1 bits");for(;s>0;)this.buffer[this.bufferLength++]=e[t++],s--,this.bufferLength===ae&&(this.hashBuffer(),this.bufferLength=0)},e.prototype.digest=function(){if(!this.finished){var e=8*this.bytesHashed,t=new DataView(this.buffer.buffer,this.buffer.byteOffset,this.buffer.byteLength),s=this.bufferLength;if(t.setUint8(this.bufferLength++,128),s%ae>=56){for(var r=this.bufferLength;r<ae;r++)t.setUint8(r,0);this.hashBuffer(),this.bufferLength=0}for(r=this.bufferLength;r<56;r++)t.setUint8(r,0);t.setUint32(56,Math.floor(e/4294967296),!0),t.setUint32(60,e),this.hashBuffer(),this.finished=!0}var n=new Uint8Array(32);for(r=0;r<8;r++)n[4*r]=this.state[r]>>>24&255,n[4*r+1]=this.state[r]>>>16&255,n[4*r+2]=this.state[r]>>>8&255,n[4*r+3]=this.state[r]>>>0&255;return n},e.prototype.hashBuffer=function(){for(var e=this.buffer,t=this.state,s=t[0],r=t[1],n=t[2],i=t[3],a=t[4],o=t[5],c=t[6],l=t[7],u=0;u<ae;u++){if(u<16)this.temp[u]=(255&e[4*u])<<24|(255&e[4*u+1])<<16|(255&e[4*u+2])<<8|255&e[4*u+3];else{var h=this.temp[u-2],p=(h>>>17|h<<15)^(h>>>19|h<<13)^h>>>10,d=((h=this.temp[u-15])>>>7|h<<25)^(h>>>18|h<<14)^h>>>3;this.temp[u]=(p+this.temp[u-7]|0)+(d+this.temp[u-16]|0)}var y=(((a>>>6|a<<26)^(a>>>11|a<<21)^(a>>>25|a<<7))+(a&o^~a&c)|0)+(l+(oe[u]+this.temp[u]|0)|0)|0,f=((s>>>2|s<<30)^(s>>>13|s<<19)^(s>>>22|s<<10))+(s&r^s&n^r&n)|0;l=c,c=o,o=a,a=i+y|0,i=n,n=r,r=s,s=y+f|0}t[0]+=s,t[1]+=r,t[2]+=n,t[3]+=i,t[4]+=a,t[5]+=o,t[6]+=c,t[7]+=l},e}(),he=function(){function e(e){this.secret=e,this.hash=new ue,this.reset()}return e.prototype.update=function(e){if(!Y(e)&&!this.error)try{this.hash.update(Q(e))}catch(e){this.error=e}},e.prototype.digestSync=function(){if(this.error)throw this.error;return this.outer?(this.outer.finished||this.outer.update(this.hash.digest()),this.outer.digest()):this.hash.digest()},e.prototype.digest=function(){return ne(this,void 0,void 0,(function(){return ie(this,(function(e){return[2,this.digestSync()]}))}))},e.prototype.reset=function(){if(this.hash=new ue,this.secret){this.outer=new ue;var e=function(e){var t=Q(e);if(t.byteLength>ae){var s=new ue;s.update(t),t=s.digest()}var r=new Uint8Array(ae);return r.set(t),r}(this.secret),t=new Uint8Array(ae);t.set(e);for(var s=0;s<ae;s++)e[s]^=54,t[s]^=92;this.hash.update(e),this.outer.update(t);for(s=0;s<e.byteLength;s++)e[s]=0}},e}();var pe=["decrypt","digest","encrypt","exportKey","generateKey","importKey","sign","verify"];function de(e){return e&&pe.every((function(t){return"function"==typeof e[t]}))}var ye=function(){function e(e){!function(e){return!(!function(e){return"object"==typeof e&&"object"==typeof e.crypto&&"function"==typeof e.crypto.getRandomValues}(e)||"object"!=typeof e.crypto.subtle)&&de(e.crypto.subtle)}(se())?this.hash=new he(e):this.hash=new re(e)}return e.prototype.update=function(e,t){this.hash.update(Q(e))},e.prototype.digest=function(){return this.hash.digest()},e.prototype.reset=function(){this.hash.reset()},e}(),fe=function(e,t,s,r){return new(s||(s=Promise))((function(n,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};const me=/^spotify:(track|album|playlist|artist):([a-zA-Z0-9]{22})$/;const ge={deserializer:{deserialize:e=>fe(void 0,void 0,void 0,(function*(){try{return yield e.json()}catch(e){return null}}))}};var ke=function(e,t,s,r){return new(s||(s=Promise))((function(n,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};const we={searchTracks:Object.freeze({$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{query:{type:"string",description:"The search query for the track."}},required:["query"]}),controlPlayback:Object.freeze({$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{action:{type:"string",description:"The action to perform. Possible values are: play, queue, pause, resume, next, previous."}},required:["action"]}),queueTrack:Object.freeze({$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{uri:{type:"string",description:"The URI of the track to queue."}},required:["uri"]}),playItem:Object.freeze({$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{uri:{type:"string",description:'The track URI to play. Optional if "contextUri" is provided.'},contextUri:{type:"string",description:'The URI of the album, artist, or playlist to start playback from. Optional if "uri" is provided.'}},required:[]}),getCurrentTrack:Object.freeze({$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{},required:[]}),getTopTracks:Object.freeze({$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{timeRange:{type:"string",description:"The time range for the top tracks. Possible values are: short_term, medium_term, long_term. Default is short_term."}},required:[]}),getRecentTracks:Object.freeze({$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{},required:[]}),getPlaylists:Object.freeze({$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{},required:[]}),getPlaylistTracks:Object.freeze({$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{playlistUri:{type:"string",description:"The URI of the playlist to get the tracks from."}},required:["playlistUri"]})},ve={searchTracks:function(e){return ke(this,arguments,void 0,(function*({query:e}){try{const t=Ue();if(!t.clientToken||!t.clientId)return"User is not authenticated with Spotify.";yield Ne(t);const s=z.withAccessToken(t.clientId,t.clientToken),r=yield s.search(e,["track"]);return r.tracks.items.map(Te)}catch(e){return console.error("Error searching tracks:",e),"Error searching tracks. See console for details."}}))},controlPlayback:function(e){return ke(this,arguments,void 0,(function*({action:e}){try{const t=Ue();if(!t.clientToken||!t.clientId)return"User is not authenticated with Spotify.";yield Ne(t);const s=z.withAccessToken(t.clientId,t.clientToken,ge),r=(yield s.player.getAvailableDevices()).devices.find((e=>e.is_active));if(!(null==r?void 0:r.id))return"No active device found. Start a Spotify client on a device.";switch(e){case"pause":return yield s.player.pausePlayback(r.id),`Paused playback on device: ${null==r?void 0:r.name}`;case"resume":return yield s.player.startResumePlayback(r.id),`Resumed playback on device: ${null==r?void 0:r.name}`;case"next":return yield s.player.skipToNext(r.id),`Skipped to next track on device: ${null==r?void 0:r.name}`;case"previous":return yield s.player.skipToPrevious(r.id),`Skipped to previous track on device: ${null==r?void 0:r.name}`;default:return"Unknown action: "+e}}catch(e){return console.error("Error controlling playback:",e),"Error controlling playback. See console for details."}}))},queueTrack:function(e){return ke(this,arguments,void 0,(function*({uri:e}){try{const t=Ue();if(!t.clientToken||!t.clientId)return"User is not authenticated with Spotify.";if(!e)return"URI is required for queue action.";yield Ne(t);const s=z.withAccessToken(t.clientId,t.clientToken,ge),r=(yield s.player.getAvailableDevices()).devices.find((e=>e.is_active));return(null==r?void 0:r.id)?(yield s.player.addItemToPlaybackQueue(e,r.id),`Track queued on device: ${null==r?void 0:r.name}`):"No active device found. Start a Spotify client on a device."}catch(e){return console.error("Error queuing track:",e),"Error queuing track. See console for details."}}))},playItem:function(e){return ke(this,arguments,void 0,(function*({uri:e,contextUri:t}){try{const s=Ue();if(!s.clientToken||!s.clientId)return"User is not authenticated with Spotify.";if(!e&&!t)return"URI or context URI is required for play action.";yield Ne(s);const r=z.withAccessToken(s.clientId,s.clientToken,ge),n=(yield r.player.getAvailableDevices()).devices.find((e=>e.is_active));if(!(null==n?void 0:n.id))return"No active device found. Start a Spotify client on a device.";const i=e?[e]:void 0;return yield r.player.startResumePlayback(n.id,t,i),`Playback started on device: ${null==n?void 0:n.name}`}catch(e){return console.error("Error queuing track:",e),"Error queuing track. See console for details."}}))},getCurrentTrack:function(){return ke(this,void 0,void 0,(function*(){try{const e=Ue();if(!e.clientToken||!e.clientId)return"User is not authenticated with Spotify.";yield Ne(e);const t=z.withAccessToken(e.clientId,e.clientToken),s=yield t.player.getCurrentlyPlayingTrack(),r="track"===s.item.type?s.item:null;return r?Te(r):"No track currently playing."}catch(e){return console.error("Error fetching current track:",e),"Error fetching current track. See console for details."}}))},getTopTracks:function(e){return ke(this,arguments,void 0,(function*({timeRange:e}){try{const t=Ue();if(!t.clientToken||!t.clientId)return"User is not authenticated with Spotify.";yield Ne(t);const s=z.withAccessToken(t.clientId,t.clientToken);["short_term","medium_term","long_term"].includes(e)||(e="short_term");return(yield s.currentUser.topItems("tracks",e)).items.map(Te)}catch(e){return console.error("Error fetching top tracks:",e),"Error fetching top tracks. See console for details."}}))},getRecentTracks:function(){return ke(this,void 0,void 0,(function*(){try{const e=Ue();if(!e.clientToken||!e.clientId)return"User is not authenticated with Spotify.";yield Ne(e);const t=z.withAccessToken(e.clientId,e.clientToken);return(yield t.player.getRecentlyPlayedTracks()).items.map((e=>Te(e.track)))}catch(e){return console.error("Error fetching recent tracks:",e),"Error fetching recent tracks. See console for details."}}))},getPlaylists:function(){return ke(this,void 0,void 0,(function*(){try{const e=Ue();if(!e.clientToken||!e.clientId)return"User is not authenticated with Spotify.";yield Ne(e);const t=z.withAccessToken(e.clientId,e.clientToken);return(yield t.currentUser.playlists.playlists()).items.map(_e)}catch(e){return console.error("Error fetching playlists:",e),"Error fetching playlists. See console for details."}}))},getPlaylistTracks:function(e){return ke(this,arguments,void 0,(function*({playlistUri:e}){try{const s=Ue();if(!s.clientToken||!s.clientId)return"User is not authenticated with Spotify.";yield Ne(s);const r=z.withAccessToken(s.clientId,s.clientToken),n=(t=e,me.test(t)?function(e){const t=e.match(me);return t?t[2]:""}(e):e);if(!n)return"Invalid playlist URI.";return(yield r.playlists.getPlaylistItems(n)).items.map((e=>Te(e.track)))}catch(e){return console.error("Error fetching playlist tracks:",e),"Error fetching playlist tracks. See console for details."}var t}))}},be={searchTracks:{name:"SpotifySearchTracks",displayName:"Spotify: Search Tracks",description:"Search for tracks on Spotify. Call when you need to find a URI for a track.",parameters:we.searchTracks,action:ve.searchTracks,shouldRegister:Se},controlPlayback:{name:"SpotifyControlPlayback",displayName:"Spotify: Control Playback",description:"Control playback on Spotify. Call when the user wants to resume, pause, or skip a track.",parameters:we.controlPlayback,action:ve.controlPlayback,shouldRegister:Se},queueTrack:{name:"SpotifyQueueTrack",displayName:"Spotify: Queue Track",description:"Queues a track on Spotify. Call when the user wants to queue a track.",parameters:we.queueTrack,action:ve.queueTrack,shouldRegister:Se},playItem:{name:"SpotifyPlayItem",displayName:"Spotify: Play Item",description:"Plays a track, album or artist on Spotify. Call when the user wants to start playback.",parameters:we.playItem,action:ve.playItem,shouldRegister:Se},getCurrentTrack:{name:"SpotifyGetCurrentTrack",displayName:"Spotify: Get Current Track",description:"Gets the current track playing on Spotify. Call when you need to display the current track.",parameters:we.getCurrentTrack,action:ve.getCurrentTrack,shouldRegister:Se},getTopTracks:{name:"SpotifyGetTopTracks",displayName:"Spotify: Get Top Tracks",description:"Gets a list of user's top tracks. Call when the user wants to see their top tracks, play a favorite track, asks for recommendations, etc.",parameters:we.getTopTracks,action:ve.getTopTracks,shouldRegister:Se},getRecentTracks:{name:"SpotifyGetRecentTracks",displayName:"Spotify: Get Recent Tracks",description:"Gets a list of user's recently played tracks. Call when the user wants to see their recent tracks.",parameters:we.getRecentTracks,action:ve.getRecentTracks,shouldRegister:Se},getPlaylists:{name:"SpotifyGetPlaylists",displayName:"Spotify: Get Playlists",description:"Gets a list of user's playlists. Call when the user wants to see their playlists.",parameters:we.getPlaylists,action:ve.getPlaylists,shouldRegister:Se},getPlaylistTracks:{name:"SpotifyGetPlaylistTracks",displayName:"Spotify: Get Playlist Tracks",description:"Gets a list of tracks in a playlist. Call when you need to see the tracks in a playlist.",parameters:we.getPlaylistTracks,action:ve.getPlaylistTracks,shouldRegister:Se}};function Te(e){return{uri:e.uri,name:e.name,artist:1===e.artists.length?e.artists[0].name:e.artists.map((e=>e.name)),artist_uri:1===e.artists.length?e.artists[0].uri:e.artists.map((e=>e.uri)),album:e.album.name,album_uri:e.album.uri,release_date:e.album.release_date}}function _e(e){return{uri:e.uri,name:e.name,description:e.description}}function Se(){return ke(this,void 0,void 0,(function*(){const e=Ue();return!(!e.clientToken||!e.clientId)}))}function Re(){const e=SillyTavern.getContext(),t=Ue();for(const[s,r]of Object.entries(be))t[s]?e.registerFunctionTool(r):e.unregisterFunctionTool(s)}var xe=function(e,t,s,r){return new(s||(s=Promise))((function(n,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};const{setExtensionPrompt:Ie,substituteParamsExtended:Ce}=SillyTavern.getContext();function qe(){Ie(K,"",M.None,0)}function Pe(){return xe(this,void 0,void 0,(function*(){qe();const e=Ue();if(e.clientToken&&e.clientId&&e.template&&e.position!==M.None)try{yield Ne(e);const t=z.withAccessToken(e.clientId,e.clientToken),s=yield t.player.getCurrentlyPlayingTrack();console.log("Currently playing Spotify track:",s);const r=function(e){var t;if(!e)return{};switch(e.type){case"track":{const s=e;return{song:s.name,artist:null===(t=s.artists.map((e=>e.name)))||void 0===t?void 0:t.join(", "),album:s.album.name,year:s.album.release_date.split("-")[0]}}case"show":{const t=e;return{song:t.name,artist:t.show.name}}}return{}}(s.item),n=Ce(e.template,r);Ie(K,n,e.position,e.depth,e.scan,e.role)}catch(e){console.error("Error fetching currently playing track:",e)}}))}const{t:Ae,saveSettingsDebounced:$e}=SillyTavern.getContext(),Ee=Object.freeze({clientId:"",clientToken:null,template:"[{{user}} is listening to {{song}} by {{artist}} on Spotify]",position:M.InChat,role:H.System,depth:1,scan:!0,searchTracks:!0,controlPlayback:!1,playItem:!0,queueTrack:!1,getCurrentTrack:!0,getTopTracks:!1,getRecentTracks:!1,getPlaylists:!1,getPlaylistTracks:!1});function Ue(){const e=SillyTavern.getContext().extensionSettings;e[G]||(e[G]=structuredClone(Ee));for(const t in Ee)void 0===e[G][t]&&(e[G][t]=Ee[t]);return e[G]}function Fe(e){var t;const s=null!==(t=document.getElementById("spotify_container"))&&void 0!==t?t:document.getElementById("extensions_settings2");if(!s)return;const r=document.createElement("template");r.innerHTML='<div id="spotify_settings"> <div class="inline-drawer"> <div class="inline-drawer-toggle inline-drawer-header"> <b> <span>Spotify</span> </b> <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div> </div> <div class="inline-drawer-content"> <div> <label for="spotify_client_id">Client ID</label> <input type="text" id="spotify_client_id" class="text_pole" placeholder="Spotify Client ID"/> </div> <div> <span>Logged in as:</span> <b id="spotify_user_name"></b> </div> <div class="flex-container"> <div id="spotify_auth" class="menu_button menu_button_icon"> <div class="fa-brands fa-spotify"></div> <span data-i18n="Authenticate">Authenticate</span> </div> <div id="spotify_logout" class="menu_button menu_button_icon"> <div class="fa-solid fa-right-from-bracket"></div> <span data-i18n="Logout">Logout</span> </div> </div> <div> <label for="spotify_template">Injection Template</label> <textarea id="spotify_template" class="text_pole textarea_compact" rows="2"></textarea> </div> <div> <label class="checkbox_label" for="spotify_scan"> <input id="spotify_scan" type="checkbox"/> <span>Include in World Info Scanning</span> </label> </div> <div> <label for="spotify_position">Injection Position</label> <div class="radio_group"> <label> <input type="radio" name="spotify_position" value="-1"/> <span data-i18n="None (not injected)">None (not injected)</span> </label> <label> <input type="radio" name="spotify_position" value="2"/> <span data-i18n="Before Main Prompt / Story String">Before Main Prompt / Story String</span> </label> <label> <input type="radio" name="spotify_position" value="0"/> <span data-i18n="After Main Prompt / Story String">After Main Prompt / Story String</span> </label> <label class="flex-container alignItemsCenter" title="How many messages before the current end of the chat." data-i18n="[title]How many messages before the current end of the chat."> <input type="radio" name="spotify_position" value="1"/> <span data-i18n="In-chat @ Depth">In-chat @ Depth</span> <input id="spotify_depth" class="text_pole widthUnset" type="number" min="0" max="999"/> <span data-i18n="as">as</span> <select id="spotify_role" class="text_pole widthNatural"> <option value="0" data-i18n="System">System</option> <option value="1" data-i18n="User">User</option> <option value="2" data-i18n="Assistant">Assistant</option> </select> </label> </div> </div> <hr> <div> <b>Function tools:</b> <label class="checkbox_label" for="spotify_tool_search_tracks"> <input id="spotify_tool_search_tracks" type="checkbox"/> <span>Search Tracks</span> </label> <label class="checkbox_label" for="spotify_tool_play_item"> <input id="spotify_tool_play_item" type="checkbox"/> <span>Play Item</span> </label> <label class="checkbox_label" for="spotify_tool_queue_track"> <input id="spotify_tool_queue_track" type="checkbox"/> <span>Queue Track</span> </label> <label class="checkbox_label" for="spotify_tool_control_playback"> <input id="spotify_tool_control_playback" type="checkbox"/> <span>Control Playback</span> </label> <label class="checkbox_label" for="spotify_tool_get_current_track"> <input id="spotify_tool_get_current_track" type="checkbox"/> <span>Get Current Track</span> </label> <label class="checkbox_label" for="spotify_tool_get_top_tracks"> <input id="spotify_tool_get_top_tracks" type="checkbox"/> <span>Get Top Tracks</span> </label> <label class="checkbox_label" for="spotify_tool_get_recent_tracks"> <input id="spotify_tool_get_recent_tracks" type="checkbox"/> <span>Get Recent Tracks</span> </label> <label class="checkbox_label" for="spotify_tool_get_playlists"> <input id="spotify_tool_get_playlists" type="checkbox"/> <span>Get User Playlists</span> </label> <label class="checkbox_label" for="spotify_tool_get_playlist_tracks"> <input id="spotify_tool_get_playlist_tracks" type="checkbox"/> <span>Get Playlist Tracks</span> </label> </div> </div> </div> </div> ',s.appendChild(r.content);const n={clientId:document.getElementById("spotify_client_id"),template:document.getElementById("spotify_template"),role:document.getElementById("spotify_role"),position:Array.from(document.getElementsByName("spotify_position")),depth:document.getElementById("spotify_depth"),scan:document.getElementById("spotify_scan"),authButton:document.getElementById("spotify_auth"),logoutButton:document.getElementById("spotify_logout"),tools:{searchTracks:document.getElementById("spotify_tool_search_tracks"),controlPlayback:document.getElementById("spotify_tool_control_playback"),playItem:document.getElementById("spotify_tool_play_item"),queueTrack:document.getElementById("spotify_tool_queue_track"),getCurrentTrack:document.getElementById("spotify_tool_get_current_track"),getTopTracks:document.getElementById("spotify_tool_get_top_tracks"),getRecentTracks:document.getElementById("spotify_tool_get_recent_tracks"),getPlaylists:document.getElementById("spotify_tool_get_playlists"),getPlaylistTracks:document.getElementById("spotify_tool_get_playlist_tracks")}};n.clientId.value=e.clientId,n.template.value=e.template,n.role.value=e.role.toString(),n.position.forEach((t=>{t.checked=e.position===parseInt(t.value)})),n.depth.value=e.depth.toString(),n.scan.checked=e.scan,n.tools.searchTracks.checked=e.searchTracks,n.tools.controlPlayback.checked=e.controlPlayback,n.tools.playItem.checked=e.playItem,n.tools.queueTrack.checked=e.queueTrack,n.tools.getCurrentTrack.checked=e.getCurrentTrack,n.tools.getTopTracks.checked=e.getTopTracks,n.tools.getRecentTracks.checked=e.getRecentTracks,n.tools.getPlaylists.checked=e.getPlaylists,n.tools.getPlaylistTracks.checked=e.getPlaylistTracks;const i=(t,s,r,n)=>{t.addEventListener("input",(()=>{const i=t instanceof HTMLInputElement&&"checkbox"===t.type?t.checked:t.value;e[s]=r?r(i):i,n&&n(),$e()}))};i(n.clientId,"clientId",(e=>e)),i(n.template,"template",(e=>e),qe),i(n.role,"role",(e=>parseInt(e)),qe),i(n.depth,"depth",(e=>parseInt(e)),qe),i(n.scan,"scan",(e=>e),qe),i(n.tools.searchTracks,"searchTracks",(e=>e),Re),i(n.tools.controlPlayback,"controlPlayback",(e=>e),Re),i(n.tools.playItem,"playItem",(e=>e),Re),i(n.tools.queueTrack,"queueTrack",(e=>e),Re),i(n.tools.getCurrentTrack,"getCurrentTrack",(e=>e),Re),i(n.tools.getTopTracks,"getTopTracks",(e=>e),Re),i(n.tools.getRecentTracks,"getRecentTracks",(e=>e),Re),i(n.tools.getPlaylists,"getPlaylists",(e=>e),Re),i(n.tools.getPlaylistTracks,"getPlaylistTracks",(e=>e),Re),n.position.forEach((t=>{t.addEventListener("input",(t=>{e.position=parseInt(t.target.value),$e()}))})),n.authButton.addEventListener("click",(()=>{!function(){je(this,void 0,void 0,(function*(){const e=Ue();if(!e.clientId)return void toastr.error(Oe`Please enter your Spotify Client ID in the settings.`);const t=function(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return crypto.getRandomValues(new Uint8Array(e)).reduce(((e,s)=>e+t[s%62]),"")}(64),s=yield function(e){const t=(new TextEncoder).encode(e),s=new ye;return s.update(t),s.digest()}(t),r=(n=s,btoa(String.fromCharCode(...new Uint8Array(n))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"));var n;const i=new URL("/callback/spotify",location.origin),a={response_type:"code",client_id:e.clientId,scope:J.join(" "),redirect_uri:i.toString(),code_challenge_method:"S256",code_challenge:r};sessionStorage.setItem(V,t);const o=new URL("https://accounts.spotify.com/authorize");o.search=new URLSearchParams(a).toString(),window.location.href=o.toString()}))}()})),n.logoutButton.addEventListener("click",(()=>{e.clientToken=null,De(Ae`[Not logged in]`),$e()}))}var je=function(e,t,s,r){return new(s||(s=Promise))((function(n,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};const{t:Oe,saveSettingsDebounced:Le}=SillyTavern.getContext();function Be(e){return je(this,void 0,void 0,(function*(){const t=function(){const e=new URLSearchParams(window.location.search);if("spotify"!==e.get("source"))return null;const t=e.get("query");if(t){const e=new URLSearchParams(t).get("code");return window.history.replaceState({},document.title,window.location.pathname),e}return null}(),s=sessionStorage.getItem(V);if(!t||!s||!e.clientId)return;const r=new URL("/callback/spotify",window.location.origin),n={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:e.clientId,grant_type:"authorization_code",redirect_uri:r.toString(),code_verifier:s,code:t})};try{const t=yield fetch("https://accounts.spotify.com/api/token",n),s=yield t.json();e.clientToken=s,sessionStorage.removeItem(V),Le(),console.log("Spotify token received:",s),toastr.success(Oe`Successfully authenticated with Spotify!`)}catch(e){console.error("Error during Spotify authentication:",e),toastr.error(Oe`Spotify authentication failed. Please try again.`)}}))}function Ne(e){return je(this,void 0,void 0,(function*(){if(!e.clientToken||!e.clientId)return;const t=e.clientToken.expires,s=e.clientToken.refresh_token,r=Date.now();if(t&&t-r<3e5){const t="https://accounts.spotify.com/api/token",r={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:s,client_id:e.clientId})};try{const n=yield fetch(t,r),i=yield n.json();e.clientToken=i,e.clientToken&&!i.refresh_token&&(e.clientToken.refresh_token=s),console.log("Spotify token refreshed:",i),Le()}catch(e){console.error("Error refreshing Spotify token:",e)}}}))}function De(e){const t=document.getElementById("spotify_user_name");t&&(t.innerText=e)}var ze=s(72),Me=s.n(ze),He=s(825),Ge=s.n(He),Ke=s(659),Ve=s.n(Ke),Je=s(56),We=s.n(Je),Qe=s(540),Ye=s.n(Qe),Ze=s(113),Xe=s.n(Ze),et=s(208),tt={};tt.styleTagTransform=Xe(),tt.setAttributes=We(),tt.insert=Ve().bind(null,"head"),tt.domAPI=Ge(),tt.insertStyleElement=Ye();Me()(et.A,tt);et.A&&et.A.locals&&et.A.locals;var st=function(e,t,s,r){return new(s||(s=Promise))((function(n,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};!function(){st(this,void 0,void 0,(function*(){const e=SillyTavern.getContext(),t=Ue();Fe(t),yield Be(t),yield Ne(t),yield function(e){return je(this,void 0,void 0,(function*(){if(e.clientToken&&e.clientId)try{const t=z.withAccessToken(e.clientId,e.clientToken),s=yield t.currentUser.profile();De(s.display_name||s.id)}catch(t){console.error("Error fetching user data:",t),e.clientToken=null,De("[Token expired]")}else De(Oe`[Not logged in]`)}))}(t),globalThis.spotify_setCurrentTrack=Pe,Re(),e.saveSettingsDebounced()}))}()})();