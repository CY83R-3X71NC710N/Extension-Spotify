(()=>{"use strict";var e={208:(e,t,s)=>{s.d(t,{A:()=>o});var r=s(601),n=s.n(r),i=s(314),a=s.n(i)()(n());a.push([e.id,"#spotify_template {\n    field-sizing: content;\n}\n",""]);const o=a},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var s="",r=void 0!==t[5];return t[4]&&(s+="@supports (".concat(t[4],") {")),t[2]&&(s+="@media ".concat(t[2]," {")),r&&(s+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),s+=e(t),r&&(s+="}"),t[2]&&(s+="}"),t[4]&&(s+="}"),s})).join("")},t.i=function(e,s,r,n,i){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(r)for(var o=0;o<this.length;o++){var c=this[o][0];null!=c&&(a[c]=!0)}for(var l=0;l<e.length;l++){var u=[].concat(e[l]);r&&a[u[0]]||(void 0!==i&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=i),s&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=s):u[2]=s),n&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=n):u[4]="".concat(n)),t.push(u))}},t}},601:e=>{e.exports=function(e){return e[1]}},72:e=>{var t=[];function s(e){for(var s=-1,r=0;r<t.length;r++)if(t[r].identifier===e){s=r;break}return s}function r(e,r){for(var i={},a=[],o=0;o<e.length;o++){var c=e[o],l=r.base?c[0]+r.base:c[0],u=i[l]||0,h="".concat(l," ").concat(u);i[l]=u+1;var p=s(h),d={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==p)t[p].references++,t[p].updater(d);else{var f=n(d,r);r.byIndex=o,t.splice(o,0,{identifier:h,updater:f,references:1})}a.push(h)}return a}function n(e,t){var s=t.domAPI(t);s.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;s.update(e=t)}else s.remove()}}e.exports=function(e,n){var i=r(e=e||[],n=n||{});return function(e){e=e||[];for(var a=0;a<i.length;a++){var o=s(i[a]);t[o].references--}for(var c=r(e,n),l=0;l<i.length;l++){var u=s(i[l]);0===t[u].references&&(t[u].updater(),t.splice(u,1))}i=c}}},659:e=>{var t={};e.exports=function(e,s){var r=function(e){if(void 0===t[e]){var s=document.querySelector(e);if(window.HTMLIFrameElement&&s instanceof window.HTMLIFrameElement)try{s=s.contentDocument.head}catch(e){s=null}t[e]=s}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(s)}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56:(e,t,s)=>{e.exports=function(e){var t=s.nc;t&&e.setAttribute("nonce",t)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(s){!function(e,t,s){var r="";s.supports&&(r+="@supports (".concat(s.supports,") {")),s.media&&(r+="@media ".concat(s.media," {"));var n=void 0!==s.layer;n&&(r+="@layer".concat(s.layer.length>0?" ".concat(s.layer):""," {")),r+=s.css,n&&(r+="}"),s.media&&(r+="}"),s.supports&&(r+="}");var i=s.sourceMap;i&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,s)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}},t={};function s(r){var n=t[r];if(void 0!==n)return n.exports;var i=t[r]={id:r,exports:{}};return e[r](i,i.exports,s),i.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.nc=void 0;class r{api;constructor(e){this.api=e}async getRequest(e){return await this.api.makeRequest("GET",e)}async postRequest(e,t,s=void 0){return await this.api.makeRequest("POST",e,t,s)}async putRequest(e,t,s=void 0){return await this.api.makeRequest("PUT",e,t,s)}async deleteRequest(e,t){return await this.api.makeRequest("DELETE",e,t)}paramsFor(e){const t=new URLSearchParams;for(let s of Object.getOwnPropertyNames(e))(e[s]||0===e[s]||!e[s]&&"boolean"==typeof e[s])&&t.append(s,e[s].toString());return[...t].length>0?`?${t.toString()}`:""}}class n extends r{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return await this.getRequest(`albums/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`albums${s}`)).albums}tracks(e,t,s,r){const n=this.paramsFor({market:t,limit:s,offset:r});return this.getRequest(`albums/${e}/tracks${n}`)}}class i extends r{async get(e){if("string"==typeof e){return this.getRequest(`artists/${e}`)}const t=this.paramsFor({ids:e});return(await this.getRequest(`artists${t}`)).artists}albums(e,t,s,r,n){const i=this.paramsFor({include_groups:t,market:s,limit:r,offset:n});return this.getRequest(`artists/${e}/albums${i}`)}topTracks(e,t){const s=this.paramsFor({market:t});return this.getRequest(`artists/${e}/top-tracks${s}`)}relatedArtists(e){return this.getRequest(`artists/${e}/related-artists`)}}class a extends r{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`audiobooks/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`audiobooks${s}`)).audiobooks}getAudiobookChapters(e,t,s,r){const n=this.paramsFor({market:t,limit:s,offset:r});return this.getRequest(`audiobooks/${e}/chapters${n}`)}}class o extends r{getCategories(e,t,s,r){const n=this.paramsFor({country:e,locale:t,limit:s,offset:r});return this.getRequest(`browse/categories${n}`)}getCategory(e,t,s){const r=this.paramsFor({country:t,locale:s});return this.getRequest(`browse/categories/${e}${r}`)}getNewReleases(e,t,s){const r=this.paramsFor({country:e,limit:t,offset:s});return this.getRequest(`browse/new-releases${r}`)}getFeaturedPlaylists(e,t,s,r,n){const i=this.paramsFor({country:e,locale:t,timestamp:s,limit:r,offset:n});return this.getRequest(`browse/featured-playlists${i}`)}getPlaylistsForCategory(e,t,s,r){const n=this.paramsFor({country:t,limit:s,offset:r});return this.getRequest(`browse/categories/${e}/playlists${n}`)}}class c extends r{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`chapters/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`chapters${s}`)).chapters}}class l extends r{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`episodes/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`episodes${s}`)).episodes}}class u extends r{get(e){const t=this.paramsFor(e);return this.getRequest(`recommendations${t}`)}genreSeeds(){return this.getRequest("recommendations/available-genre-seeds")}}class h extends r{getAvailableMarkets(){return this.getRequest("markets")}}class p extends r{getPlaybackState(e,t){const s=this.paramsFor({market:e,additional_types:t});return this.getRequest(`me/player${s}`)}getAvailableDevices(){return this.getRequest("me/player/devices")}getCurrentlyPlayingTrack(e,t){const s=this.paramsFor({market:e,additional_types:t});return this.getRequest(`me/player/currently-playing${s}`)}getRecentlyPlayedTracks(e,t){const s={limit:e};t&&("before"===t.type?s.before=t.timestamp:"after"===t.type&&(s.after=t.timestamp));const r=this.paramsFor(s);return this.getRequest(`me/player/recently-played${r}`)}getUsersQueue(){return this.getRequest("me/player/queue")}async transferPlayback(e,t){if(e.length>1)throw new Error("Although an array is accepted, only a single device_id is currently supported. Supplying more than one will return 400 Bad Request");await this.putRequest("me/player",{device_ids:e,play:t})}async startResumePlayback(e,t,s,r,n){const i=this.paramsFor({device_id:e});await this.putRequest(`me/player/play${i}`,{context_uri:t,uris:s,offset:r,positionMs:n})}async pausePlayback(e){const t=this.paramsFor({device_id:e});await this.putRequest(`me/player/pause${t}`)}async skipToNext(e){const t=this.paramsFor({device_id:e});await this.postRequest(`me/player/next${t}`)}async skipToPrevious(e){const t=this.paramsFor({device_id:e});await this.postRequest(`me/player/previous${t}`)}async seekToPosition(e,t){const s=this.paramsFor({position_ms:e,device_id:t});await this.putRequest(`me/player/seek${s}`)}async setRepeatMode(e,t){const s=this.paramsFor({state:e,device_id:t});await this.putRequest(`me/player/repeat${s}`)}async setPlaybackVolume(e,t){const s=this.paramsFor({volume_percent:e,device_id:t});await this.putRequest(`me/player/volume${s}`)}async togglePlaybackShuffle(e,t){const s=this.paramsFor({state:e,device_id:t});await this.putRequest(`me/player/shuffle${s}`)}async addItemToPlaybackQueue(e,t){const s=this.paramsFor({uri:e,device_id:t});await this.postRequest(`me/player/queue${s}`)}}class d extends r{getPlaylist(e,t,s,r){const n=this.paramsFor({market:t,fields:s,additional_types:r?.join(",")});return this.getRequest(`playlists/${e}${n}`)}getPlaylistItems(e,t,s,r,n,i){const a=this.paramsFor({market:t,fields:s,limit:r,offset:n,additional_types:i?.join(",")});return this.getRequest(`playlists/${e}/tracks${a}`)}async changePlaylistDetails(e,t){await this.putRequest(`playlists/${e}`,t)}movePlaylistItems(e,t,s,r){return this.updatePlaylistItems(e,{range_start:t,range_length:s,insert_before:r})}updatePlaylistItems(e,t){return this.putRequest(`playlists/${e}/tracks`,t)}async addItemsToPlaylist(e,t,s){await this.postRequest(`playlists/${e}/tracks`,{position:s,uris:t})}async removeItemsFromPlaylist(e,t){await this.deleteRequest(`playlists/${e}/tracks`,t)}getUsersPlaylists(e,t,s){const r=this.paramsFor({limit:t,offset:s});return this.getRequest(`users/${e}/playlists${r}`)}createPlaylist(e,t){return this.postRequest(`users/${e}/playlists`,t)}getPlaylistCoverImage(e){return this.getRequest(`playlists/${e}/images`)}async addCustomPlaylistCoverImage(e,t){let s="";if(t instanceof Buffer)s=t.toString("base64");else if(t instanceof HTMLCanvasElement)s=t.toDataURL("image/jpeg").split(";base64,")[1];else if(t instanceof HTMLImageElement){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const r=e.getContext("2d");if(!r)throw new Error("Could not get canvas context");r.drawImage(t,0,0),s=e.toDataURL("image/jpeg").split(";base64,")[1]}else{if("string"!=typeof t)throw new Error("ImageData must be a Buffer, HTMLImageElement, HTMLCanvasElement, or string containing a base64 encoded jpeg");s=t}await this.addCustomPlaylistCoverImageFromBase64String(e,s)}async addCustomPlaylistCoverImageFromBase64String(e,t){await this.putRequest(`playlists/${e}/images`,t,"image/jpeg")}}class f extends r{async execute(e,t,s,r,n,i){const a=this.paramsFor({q:e,type:t,market:s,limit:r,offset:n,include_external:i});return await this.getRequest(`search${a}`)}}class y extends r{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`shows/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`shows${s}`)).shows}episodes(e,t,s,r){const n=this.paramsFor({market:t,limit:s,offset:r});return this.getRequest(`shows/${e}/episodes${n}`)}}class m extends r{async get(e,t){if("string"==typeof e){const s=this.paramsFor({market:t});return this.getRequest(`tracks/${e}${s}`)}const s=this.paramsFor({ids:e,market:t});return(await this.getRequest(`tracks${s}`)).tracks}async audioFeatures(e){if("string"==typeof e)return this.getRequest(`audio-features/${e}`);const t=this.paramsFor({ids:e});return(await this.getRequest(`audio-features${t}`)).audio_features}audioAnalysis(e){return this.getRequest(`audio-analysis/${e}`)}}const g={access_token:"emptyAccessToken",token_type:"",expires_in:0,refresh_token:"",expires:-1};function w(e){return e===g}class k extends r{profile(e){return this.getRequest(`users/${e}`)}}class v extends r{albums;audiobooks;episodes;playlists;shows;tracks;constructor(e){super(e),this.albums=new b(e),this.audiobooks=new T(e),this.episodes=new _(e),this.playlists=new S(e),this.shows=new R(e),this.tracks=new x(e)}profile(){return this.getRequest("me")}topItems(e,t,s,r){const n=this.paramsFor({time_range:t,limit:s,offset:r});return this.getRequest(`me/top/${e}${n}`)}followedArtists(e,t){const s=this.paramsFor({type:"artist",after:e,limit:t});return this.getRequest(`me/following${s}`)}async followArtistsOrUsers(e,t){const s=this.paramsFor({type:t});await this.putRequest(`me/following${s}`,{ids:e})}async unfollowArtistsOrUsers(e,t){const s=this.paramsFor({type:t});await this.deleteRequest(`me/following${s}`,{ids:e})}followsArtistsOrUsers(e,t){const s=this.paramsFor({ids:e,type:t});return this.getRequest(`me/following/contains${s}`)}}class b extends r{savedAlbums(e,t,s){const r=this.paramsFor({limit:e,offset:t,market:s});return this.getRequest(`me/albums${r}`)}async saveAlbums(e){await this.putRequest("me/albums",e)}async removeSavedAlbums(e){await this.deleteRequest("me/albums",e)}hasSavedAlbums(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/albums/contains${t}`)}}class T extends r{savedAudiobooks(e,t){const s=this.paramsFor({limit:e,offset:t});return this.getRequest(`me/audiobooks${s}`)}async saveAudiobooks(e){await this.putRequest("me/audiobooks",e)}async removeSavedAudiobooks(e){await this.deleteRequest("me/audiobooks",e)}hasSavedAudiobooks(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/audiobooks/contains${t}`)}}class _ extends r{savedEpisodes(e,t,s){const r=this.paramsFor({market:e,limit:t,offset:s});return this.getRequest(`me/episodes${r}`)}async saveEpisodes(e){await this.putRequest("me/episodes",e)}async removeSavedEpisodes(e){await this.deleteRequest("me/episodes",e)}hasSavedEpisodes(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/episodes/contains${t}`)}}class S extends r{playlists(e,t){const s=this.paramsFor({limit:e,offset:t});return this.getRequest(`me/playlists${s}`)}async follow(e){await this.putRequest(`playlists/${e}/followers`)}async unfollow(e){await this.deleteRequest(`playlists/${e}/followers`)}isFollowing(e,t){const s=this.paramsFor({ids:t});return this.getRequest(`playlists/${e}/followers/contains${s}`)}}class R extends r{savedShows(e,t){const s=this.paramsFor({limit:e,offset:t});return this.getRequest(`me/shows${s}`)}saveShows(e){const t=this.paramsFor({ids:e});return this.putRequest(`me/shows${t}`)}removeSavedShows(e,t){const s=this.paramsFor({ids:e,market:t});return this.deleteRequest(`me/shows${s}`)}hasSavedShow(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/shows/contains${t}`)}}class x extends r{savedTracks(e,t,s){const r=this.paramsFor({limit:e,offset:t,market:s});return this.getRequest(`me/tracks${r}`)}async saveTracks(e){await this.putRequest("me/tracks",e)}async removeSavedTracks(e){await this.deleteRequest("me/tracks",e)}hasSavedTracks(e){const t=this.paramsFor({ids:e});return this.getRequest(`me/tracks/contains${t}`)}}class I{static get current(){return this.hasSubtleCrypto?window.crypto:this.tryLoadNodeWebCrypto()}static get hasSubtleCrypto(){return"undefined"!=typeof window&&void 0!==window.crypto&&void 0!==window.crypto.subtle}static tryLoadNodeWebCrypto(){try{const{webcrypto:e}=require("crypto");return e}catch(e){throw e}}}class C{static async refreshCachedAccessToken(e,t){const s=await C.refreshToken(e,t.refresh_token);return C.toCachable(s)}static toCachable(e){return e.expires&&-1===e.expires?e:{...e,expires:this.calculateExpiry(e)}}static calculateExpiry(e){return Date.now()+1e3*e.expires_in}static async refreshToken(e,t){const s=new URLSearchParams;s.append("client_id",e),s.append("grant_type","refresh_token"),s.append("refresh_token",t);const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s}),n=await r.text();if(!r.ok)throw new Error(`Failed to refresh token: ${r.statusText}, ${n}`);return JSON.parse(n)}static generateCodeVerifier(e){let t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let r=0;r<e;r++)t+=s.charAt(Math.floor(62*Math.random()));return t}static async generateCodeChallenge(e){const t=(new TextEncoder).encode(e),s=await I.current.subtle.digest("SHA-256",t),r=[...new Uint8Array(s)];return("undefined"!=typeof Buffer?Buffer.from(s).toString("base64"):btoa(String.fromCharCode.apply(null,r))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}}class q{clientId;clientSecret;scopes;static cacheKey="spotify-sdk:ClientCredentialsStrategy:token";configuration=null;get cache(){return this.configuration.cachingStrategy}constructor(e,t,s=[]){this.clientId=e,this.clientSecret=t,this.scopes=s}setConfiguration(e){this.configuration=e}async getOrCreateAccessToken(){return await this.cache.getOrCreate(q.cacheKey,(async()=>{const e=await this.getTokenFromApi();return C.toCachable(e)}),(async e=>{const t=await this.getTokenFromApi();return C.toCachable(t)}))}async getAccessToken(){return await this.cache.get(q.cacheKey)}removeAccessToken(){this.cache.remove(q.cacheKey)}async getTokenFromApi(){const e={grant_type:"client_credentials",scope:this.scopes.join(" ")},t=Object.keys(e).map((t=>t+"="+e[t])).join("&"),s="undefined"!=typeof Buffer,r=`${this.clientId}:${this.clientSecret}`,n=s?Buffer.from(r).toString("base64"):btoa(r),i=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${n}`},body:t});if(200!==i.status)throw new Error("Failed to get access token.");return await i.json()}}class A{clientId;redirectUri;scopes;static cacheKey="spotify-sdk:ImplicitGrantStrategy:token";configuration=null;get cache(){return this.configuration.cachingStrategy}constructor(e,t,s){this.clientId=e,this.redirectUri=t,this.scopes=s}setConfiguration(e){this.configuration=e}async getOrCreateAccessToken(){return await this.cache.getOrCreate(A.cacheKey,(async()=>{const e=await this.redirectOrVerifyToken();return C.toCachable(e)}),(async e=>C.refreshCachedAccessToken(this.clientId,e)))}async getAccessToken(){return await this.cache.get(A.cacheKey)}removeAccessToken(){this.cache.remove(A.cacheKey)}async redirectOrVerifyToken(){const e=new URLSearchParams(window.location.hash.substring(1)),t=e.get("access_token");if(t)return Promise.resolve({access_token:t,token_type:e.get("token_type")??"",expires_in:parseInt(e.get("expires_in")??"0"),refresh_token:e.get("refresh_token")??"",expires:Number(e.get("expires"))||0});var s=(this.scopes??[]).join(" ");const r=new URLSearchParams;r.append("client_id",this.clientId),r.append("response_type","token"),r.append("redirect_uri",this.redirectUri),r.append("scope",s);const n="https://accounts.spotify.com/authorize?"+r.toString();return this.configuration.redirectionStrategy.redirect(n),g}}class P{clientId;redirectUri;scopes;static cacheKey="spotify-sdk:AuthorizationCodeWithPKCEStrategy:token";configuration=null;get cache(){return this.configuration.cachingStrategy}constructor(e,t,s){this.clientId=e,this.redirectUri=t,this.scopes=s}setConfiguration(e){this.configuration=e}async getOrCreateAccessToken(){return await this.cache.getOrCreate(P.cacheKey,(async()=>{const e=await this.redirectOrVerifyToken();return C.toCachable(e)}),(async e=>C.refreshCachedAccessToken(this.clientId,e)))}async getAccessToken(){return await this.cache.get(P.cacheKey)}removeAccessToken(){this.cache.remove(P.cacheKey)}async redirectOrVerifyToken(){const e=new URLSearchParams(window.location.search).get("code");if(e){const t=await this.verifyAndExchangeCode(e);return this.removeCodeFromUrl(),t}return this.redirectToSpotify(),g}async redirectToSpotify(){const e=C.generateCodeVerifier(128),t=await C.generateCodeChallenge(e),s={verifier:e,expiresOnAccess:!0};this.cache.setCacheItem("spotify-sdk:verifier",s);const r=await this.generateRedirectUrlForUser(this.scopes,t);await this.configuration.redirectionStrategy.redirect(r)}async verifyAndExchangeCode(e){const t=await this.cache.get("spotify-sdk:verifier"),s=t?.verifier;if(!s)throw new Error("No verifier found in cache - can't validate query string callback parameters.");return await this.configuration.redirectionStrategy.onReturnFromRedirect(),await this.exchangeCodeForToken(e,s)}removeCodeFromUrl(){const e=new URL(window.location.href);e.searchParams.delete("code");const t=e.search?e.href:e.href.replace("?","");window.history.replaceState({},document.title,t)}async generateRedirectUrlForUser(e,t){const s=e.join(" "),r=new URLSearchParams;return r.append("client_id",this.clientId),r.append("response_type","code"),r.append("redirect_uri",this.redirectUri),r.append("scope",s),r.append("code_challenge_method","S256"),r.append("code_challenge",t),`https://accounts.spotify.com/authorize?${r.toString()}`}async exchangeCodeForToken(e,t){const s=new URLSearchParams;s.append("client_id",this.clientId),s.append("grant_type","authorization_code"),s.append("code",e),s.append("redirect_uri",this.redirectUri),s.append("code_verifier",t);const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s}),n=await r.text();if(!r.ok)throw new Error(`Failed to exchange code for token: ${r.statusText}, ${n}`);return JSON.parse(n)}}class ${async deserialize(e){const t=await e.text();if(t.length>0){return JSON.parse(t)}return null}}class E{async validateResponse(e){switch(e.status){case 401:throw new Error("Bad or expired token. This can happen if the user revoked a token or the access token has expired. You should re-authenticate the user.");case 403:const t=await e.text();throw new Error(`Bad OAuth request (wrong consumer key, bad nonce, expired timestamp...). Unfortunately, re-authenticating the user won't help here. Body: ${t}`);case 429:throw new Error("The app has exceeded its rate limits.");default:if(!e.status.toString().startsWith("20")){const t=await e.text();throw new Error(`Unrecognised response code: ${e.status} - ${e.statusText}. Body: ${t}`)}}}}class F{async handleErrors(e){return!1}}class U{async redirect(e){document.location=e.toString()}async onReturnFromRedirect(){}}class O{storage;updateFunctions;autoRenewInterval;autoRenewWindow;constructor(e,t=new Map,s=0,r=12e4){this.storage=e,this.updateFunctions=t,this.autoRenewInterval=s,this.autoRenewWindow=r,this.autoRenewInterval>0&&setInterval((()=>this.autoRenewRenewableItems()),this.autoRenewInterval)}async getOrCreate(e,t,s){s&&this.updateFunctions.set(e,s);const r=await this.get(e);if(r)return r;const n=await t();if(!n)throw new Error("Could not create cache item");return w(n)||this.setCacheItem(e,n),n}async get(e){let t=this.storage.get(e),s=t?JSON.parse(t):null;if(this.itemDueToExpire(s)&&this.updateFunctions.has(e)){const r=this.updateFunctions.get(e);await this.tryUpdateItem(e,s,r),t=this.storage.get(e),s=t?JSON.parse(t):null}return s?s.expires&&(-1===s.expires||s.expires<=Date.now())?(this.remove(e),null):s.expiresOnAccess&&!0===s.expiresOnAccess?(this.remove(e),s):s:null}set(e,t,s){const r={...t,expires:Date.now()+s};this.setCacheItem(e,r)}setCacheItem(e,t){const s=JSON.stringify(t);this.storage.set(e,s)}remove(e){this.storage.remove(e)}itemDueToExpire(e){return!!e&&(!!e.expires&&e.expires-Date.now()<this.autoRenewWindow)}async autoRenewRenewableItems(){this.updateFunctions.forEach((async(e,t)=>{const s=await this.get(t);s&&e&&this.itemDueToExpire(s)&&await this.tryUpdateItem(t,s,e)}))}async tryUpdateItem(e,t,s){try{const r=await s(t);r&&this.setCacheItem(e,r)}catch(e){console.error(e)}}}class L extends O{constructor(){super(new j)}}class j{get(e){return localStorage.getItem(e)}set(e,t){localStorage.setItem(e,t)}remove(e){localStorage.removeItem(e)}}class B extends O{constructor(){super(new N)}}class N{cache=new Map;get(e){return this.cache.get(e)??null}set(e,t){this.cache.set(e,t)}remove(e){this.cache.delete(e)}}class M{clientId;accessToken;refreshTokenAction;constructor(e,t,s){this.clientId=e,this.accessToken=t,this.refreshTokenAction=s||C.refreshCachedAccessToken,this.accessToken.expires||(this.accessToken.expires=C.calculateExpiry(this.accessToken))}setConfiguration(e){}async getOrCreateAccessToken(){if(this.accessToken.expires&&this.accessToken.expires<=Date.now()){const e=await this.refreshTokenAction(this.clientId,this.accessToken);this.accessToken=e}return this.accessToken}async getAccessToken(){return this.accessToken}removeAccessToken(){this.accessToken={access_token:"",token_type:"",expires_in:0,refresh_token:"",expires:0}}}class H{sdkConfig;static rootUrl="https://api.spotify.com/v1/";authenticationStrategy;albums;artists;audiobooks;browse;chapters;episodes;recommendations;markets;player;playlists;shows;tracks;users;search;currentUser;constructor(e,t){this.sdkConfig=this.initializeSdk(t),this.albums=new n(this),this.artists=new i(this),this.audiobooks=new a(this),this.browse=new o(this),this.chapters=new c(this),this.episodes=new l(this),this.recommendations=new u(this),this.markets=new h(this),this.player=new p(this),this.playlists=new d(this),this.shows=new y(this),this.tracks=new m(this),this.users=new k(this),this.currentUser=new v(this);const s=new f(this);this.search=s.execute.bind(s),this.authenticationStrategy=e,this.authenticationStrategy.setConfiguration(this.sdkConfig)}async makeRequest(e,t,s=void 0,r=void 0){try{const n=await this.authenticationStrategy.getOrCreateAccessToken();if(w(n))return console.warn("No access token found, authenticating now."),null;const i=n?.access_token,a=H.rootUrl+t,o={method:e,headers:{Authorization:`Bearer ${i}`,"Content-Type":r??"application/json"},body:s?"string"==typeof s?s:JSON.stringify(s):void 0};this.sdkConfig.beforeRequest(a,o);const c=await this.sdkConfig.fetch(a,o);return this.sdkConfig.afterRequest(a,o,c),204===c.status?null:(await this.sdkConfig.responseValidator.validateResponse(c),this.sdkConfig.deserializer.deserialize(c))}catch(e){if(!await this.sdkConfig.errorHandler.handleErrors(e))throw e;return null}}initializeSdk(e){const t="undefined"!=typeof window;return{...{fetch:(e,t)=>fetch(e,t),beforeRequest:(e,t)=>{},afterRequest:(e,t,s)=>{},deserializer:new $,responseValidator:new E,errorHandler:new F,redirectionStrategy:new U,cachingStrategy:t?new L:new B},...e}}switchAuthenticationStrategy(e){this.authenticationStrategy=e,this.authenticationStrategy.setConfiguration(this.sdkConfig),this.authenticationStrategy.getOrCreateAccessToken()}async authenticate(){const e=await this.authenticationStrategy.getOrCreateAccessToken();return{authenticated:e.expires>Date.now()&&!w(e),accessToken:e}}async getAccessToken(){return this.authenticationStrategy.getAccessToken()}logOut(){this.authenticationStrategy.removeAccessToken()}static withUserAuthorization(e,t,s=[],r){const n=new P(e,t,s);return new H(n,r)}static withClientCredentials(e,t,s=[],r){const n=new q(e,t,s);return new H(n,r)}static withImplicitGrant(e,t,s=[],r){const n=new A(e,t,s);return new H(n,r)}static withAccessToken(e,t,s){const r=new M(e,t);return new H(r,s)}static async performUserAuthorization(e,t,s,r,n){const i=new P(e,t,s),a=new H(i,n),o=await a.authenticationStrategy.getOrCreateAccessToken();return w(o)||("string"==typeof r?(console.log("Posting access token to postback URL."),await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})):await r(o)),{authenticated:o.expires>Date.now()&&!w(o),accessToken:o}}}var D="undefined"!=typeof Buffer&&Buffer.from?function(e){return Buffer.from(e,"utf8")}:e=>(new TextEncoder).encode(e);function z(e){return e instanceof Uint8Array?e:"string"==typeof e?D(e):ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength/Uint8Array.BYTES_PER_ELEMENT):new Uint8Array(e)}function K(e){return"string"==typeof e?0===e.length:0===e.byteLength}var V={name:"SHA-256"},G={name:"HMAC",hash:V},J=new Uint8Array([227,176,196,66,152,252,28,20,154,251,244,200,153,111,185,36,39,174,65,228,100,155,147,76,164,149,153,27,120,82,184,85]);const W={};function Q(){return"undefined"!=typeof window?window:"undefined"!=typeof self?self:W}var Y=function(){function e(e){this.toHash=new Uint8Array(0),this.secret=e,this.reset()}return e.prototype.update=function(e){if(!K(e)){var t=z(e),s=new Uint8Array(this.toHash.byteLength+t.byteLength);s.set(this.toHash,0),s.set(t,this.toHash.byteLength),this.toHash=s}},e.prototype.digest=function(){var e=this;return this.key?this.key.then((function(t){return Q().crypto.subtle.sign(G,t,e.toHash).then((function(e){return new Uint8Array(e)}))})):K(this.toHash)?Promise.resolve(J):Promise.resolve().then((function(){return Q().crypto.subtle.digest(V,e.toHash)})).then((function(e){return Promise.resolve(new Uint8Array(e))}))},e.prototype.reset=function(){var e=this;this.toHash=new Uint8Array(0),this.secret&&void 0!==this.secret&&(this.key=new Promise((function(t,s){Q().crypto.subtle.importKey("raw",z(e.secret),G,!1,["sign"]).then(t,s)})),this.key.catch((function(){})))},e}();function X(e,t,s,r){return new(s||(s=Promise))((function(n,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))}function Z(e,t){var s,r,n,i={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(c){return function(o){if(s)throw new TypeError("Generator is already executing.");for(;a&&(a=0,o[0]&&(i=0)),i;)try{if(s=1,r&&(n=2&o[0]?r.return:o[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(n=i.trys,(n=n.length>0&&n[n.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){i.label=o[1];break}if(6===o[0]&&i.label<n[1]){i.label=n[1],n=o;break}if(n&&i.label<n[2]){i.label=n[2],i.ops.push(o);break}n[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{s=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}}Object.create;Object.create;"function"==typeof SuppressedError&&SuppressedError;var ee=64,te=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),se=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],re=Math.pow(2,53)-1,ne=function(){function e(){this.state=Int32Array.from(se),this.temp=new Int32Array(64),this.buffer=new Uint8Array(64),this.bufferLength=0,this.bytesHashed=0,this.finished=!1}return e.prototype.update=function(e){if(this.finished)throw new Error("Attempted to update an already finished hash.");var t=0,s=e.byteLength;if(this.bytesHashed+=s,8*this.bytesHashed>re)throw new Error("Cannot hash more than 2^53 - 1 bits");for(;s>0;)this.buffer[this.bufferLength++]=e[t++],s--,this.bufferLength===ee&&(this.hashBuffer(),this.bufferLength=0)},e.prototype.digest=function(){if(!this.finished){var e=8*this.bytesHashed,t=new DataView(this.buffer.buffer,this.buffer.byteOffset,this.buffer.byteLength),s=this.bufferLength;if(t.setUint8(this.bufferLength++,128),s%ee>=56){for(var r=this.bufferLength;r<ee;r++)t.setUint8(r,0);this.hashBuffer(),this.bufferLength=0}for(r=this.bufferLength;r<56;r++)t.setUint8(r,0);t.setUint32(56,Math.floor(e/4294967296),!0),t.setUint32(60,e),this.hashBuffer(),this.finished=!0}var n=new Uint8Array(32);for(r=0;r<8;r++)n[4*r]=this.state[r]>>>24&255,n[4*r+1]=this.state[r]>>>16&255,n[4*r+2]=this.state[r]>>>8&255,n[4*r+3]=this.state[r]>>>0&255;return n},e.prototype.hashBuffer=function(){for(var e=this.buffer,t=this.state,s=t[0],r=t[1],n=t[2],i=t[3],a=t[4],o=t[5],c=t[6],l=t[7],u=0;u<ee;u++){if(u<16)this.temp[u]=(255&e[4*u])<<24|(255&e[4*u+1])<<16|(255&e[4*u+2])<<8|255&e[4*u+3];else{var h=this.temp[u-2],p=(h>>>17|h<<15)^(h>>>19|h<<13)^h>>>10,d=((h=this.temp[u-15])>>>7|h<<25)^(h>>>18|h<<14)^h>>>3;this.temp[u]=(p+this.temp[u-7]|0)+(d+this.temp[u-16]|0)}var f=(((a>>>6|a<<26)^(a>>>11|a<<21)^(a>>>25|a<<7))+(a&o^~a&c)|0)+(l+(te[u]+this.temp[u]|0)|0)|0,y=((s>>>2|s<<30)^(s>>>13|s<<19)^(s>>>22|s<<10))+(s&r^s&n^r&n)|0;l=c,c=o,o=a,a=i+f|0,i=n,n=r,r=s,s=f+y|0}t[0]+=s,t[1]+=r,t[2]+=n,t[3]+=i,t[4]+=a,t[5]+=o,t[6]+=c,t[7]+=l},e}(),ie=function(){function e(e){this.secret=e,this.hash=new ne,this.reset()}return e.prototype.update=function(e){if(!K(e)&&!this.error)try{this.hash.update(z(e))}catch(e){this.error=e}},e.prototype.digestSync=function(){if(this.error)throw this.error;return this.outer?(this.outer.finished||this.outer.update(this.hash.digest()),this.outer.digest()):this.hash.digest()},e.prototype.digest=function(){return X(this,void 0,void 0,(function(){return Z(this,(function(e){return[2,this.digestSync()]}))}))},e.prototype.reset=function(){if(this.hash=new ne,this.secret){this.outer=new ne;var e=function(e){var t=z(e);if(t.byteLength>ee){var s=new ne;s.update(t),t=s.digest()}var r=new Uint8Array(ee);return r.set(t),r}(this.secret),t=new Uint8Array(ee);t.set(e);for(var s=0;s<ee;s++)e[s]^=54,t[s]^=92;this.hash.update(e),this.outer.update(t);for(s=0;s<e.byteLength;s++)e[s]=0}},e}();var ae=["decrypt","digest","encrypt","exportKey","generateKey","importKey","sign","verify"];function oe(e){return e&&ae.every((function(t){return"function"==typeof e[t]}))}var ce,le,ue=function(){function e(e){!function(e){return!(!function(e){return"object"==typeof e&&"object"==typeof e.crypto&&"function"==typeof e.crypto.getRandomValues}(e)||"object"!=typeof e.crypto.subtle)&&oe(e.crypto.subtle)}(Q())?this.hash=new ie(e):this.hash=new Y(e)}return e.prototype.update=function(e,t){this.hash.update(z(e))},e.prototype.digest=function(){return this.hash.digest()},e.prototype.reset=function(){this.hash.reset()},e}();!function(e){e[e.None=-1]="None",e[e.AfterPrompt=0]="AfterPrompt",e[e.InChat=1]="InChat",e[e.BeforePrompt=2]="BeforePrompt"}(ce||(ce={})),function(e){e[e.System=0]="System",e[e.User=1]="User",e[e.Assistant=2]="Assistant"}(le||(le={}));const he="spotify",pe="spotify_inject",de="spotify_verifier",fe=["user-read-private","user-read-playback-state","user-top-read","user-modify-playback-state","playlist-read-private"],ye={searchTracks:Object.freeze({$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{query:{type:"string",description:"The search query for the track."}},required:["query"]}),controlPlayback:Object.freeze({$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{action:{type:"string",description:"The action to perform on the track. Possible values are: play, pause, resume, next, previous."},uri:{type:"string",description:"The URI of the track to perform the action on. Required for play action."}},required:["action"]}),getTopTracks:Object.freeze({$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{timeRange:{type:"string",description:"The time range for the top tracks. Possible values are: short_term, medium_term, long_term."}},required:[]}),getPlaylists:Object.freeze({$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{},required:[]})},me=Object.freeze({clientId:"",clientToken:null,template:"[{{user}} is listening to {{song}} by {{artist}} on Spotify]",position:ce.InChat,role:le.System,depth:1,scan:!0,searchTracks:!0,controlPlayback:!0,getTopTracks:!0,getPlaylists:!0});function ge(){const e=SillyTavern.getContext().extensionSettings;e[he]||(e[he]=structuredClone(me));for(const t in me)void 0===e[he][t]&&(e[he][t]=me[t]);return e[he]}var we=s(72),ke=s.n(we),ve=s(825),be=s.n(ve),Te=s(659),_e=s.n(Te),Se=s(56),Re=s.n(Se),xe=s(540),Ie=s.n(xe),Ce=s(113),qe=s.n(Ce),Ae=s(208),Pe={};Pe.styleTagTransform=qe(),Pe.setAttributes=Re(),Pe.insert=_e().bind(null,"head"),Pe.domAPI=be(),Pe.insertStyleElement=Ie();ke()(Ae.A,Pe);Ae.A&&Ae.A.locals&&Ae.A.locals;var $e=function(e,t,s,r){return new(s||(s=Promise))((function(n,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};const{saveSettingsDebounced:Ee,setExtensionPrompt:Fe,substituteParamsExtended:Ue,registerFunctionTool:Oe,unregisterFunctionTool:Le,t:je}=SillyTavern.getContext();function Be(e){var t;const s=null!==(t=document.getElementById("spotify_container"))&&void 0!==t?t:document.getElementById("extensions_settings2");if(!s)return;const r=document.createElement("template");r.innerHTML='<div id="spotify_settings"> <div class="inline-drawer"> <div class="inline-drawer-toggle inline-drawer-header"> <b> <span>Spotify</span> </b> <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div> </div> <div class="inline-drawer-content"> <div> <label for="spotify_client_id">Client ID</label> <input type="text" id="spotify_client_id" class="text_pole" placeholder="Spotify Client ID"/> </div> <div> <span>Logged in as:</span> <b id="spotify_user_name"></b> </div> <div class="flex-container"> <div id="spotify_auth" class="menu_button menu_button_icon"> <div class="fa-brands fa-spotify"></div> <span data-i18n="Authenticate">Authenticate</span> </div> <div id="spotify_logout" class="menu_button menu_button_icon"> <div class="fa-solid fa-right-from-bracket"></div> <span data-i18n="Logout">Logout</span> </div> </div> <div> <label for="spotify_template">Injection Template</label> <textarea id="spotify_template" class="text_pole textarea_compact" rows="2"></textarea> </div> <div> <label class="checkbox_label" for="spotify_scan"> <input id="spotify_scan" type="checkbox"/> <span>Include in World Info Scanning</span> </label> </div> <div> <label for="spotify_position">Injection Position</label> <div class="radio_group"> <label> <input type="radio" name="spotify_position" value="-1"/> <span data-i18n="None (not injected)">None (not injected)</span> </label> <label> <input type="radio" name="spotify_position" value="2"/> <span data-i18n="Before Main Prompt / Story String">Before Main Prompt / Story String</span> </label> <label> <input type="radio" name="spotify_position" value="0"/> <span data-i18n="After Main Prompt / Story String">After Main Prompt / Story String</span> </label> <label class="flex-container alignItemsCenter" title="How many messages before the current end of the chat." data-i18n="[title]How many messages before the current end of the chat."> <input type="radio" name="spotify_position" value="1"/> <span data-i18n="In-chat @ Depth">In-chat @ Depth</span> <input id="spotify_depth" class="text_pole widthUnset" type="number" min="0" max="999"/> <span data-i18n="as">as</span> <select id="spotify_role" class="text_pole widthNatural"> <option value="0" data-i18n="System">System</option> <option value="1" data-i18n="User">User</option> <option value="2" data-i18n="Assistant">Assistant</option> </select> </label> </div> </div> <hr> <div> <b>Function tools:</b> <label class="checkbox_label" for="spotify_tool_search_tracks"> <input id="spotify_tool_search_tracks" type="checkbox"/> <span>Search Tracks</span> </label> <label class="checkbox_label" for="spotify_tool_control_playback"> <input id="spotify_tool_control_playback" type="checkbox"/> <span>Control Playback</span> </label> <label class="checkbox_label" for="spotify_tool_get_top_tracks"> <input id="spotify_tool_get_top_tracks" type="checkbox"/> <span>Get Top Tracks</span> </label> <label class="checkbox_label" for="spotify_tool_get_playlists"> <input id="spotify_tool_get_playlists" type="checkbox"/> <span>Get Playlists</span> </label> </div> </div> </div> </div> ',s.appendChild(r.content);const n={clientId:document.getElementById("spotify_client_id"),template:document.getElementById("spotify_template"),role:document.getElementById("spotify_role"),position:Array.from(document.getElementsByName("spotify_position")),depth:document.getElementById("spotify_depth"),scan:document.getElementById("spotify_scan"),authButton:document.getElementById("spotify_auth"),logoutButton:document.getElementById("spotify_logout"),tools:{searchTracks:document.getElementById("spotify_tool_search_tracks"),controlPlayback:document.getElementById("spotify_tool_control_playback"),getTopTracks:document.getElementById("spotify_tool_get_top_tracks"),getPlaylists:document.getElementById("spotify_tool_get_playlists")}};n.clientId.value=e.clientId,n.template.value=e.template,n.role.value=e.role.toString(),n.position.forEach((t=>{t.checked=e.position===parseInt(t.value)})),n.depth.value=e.depth.toString(),n.scan.checked=e.scan,n.tools.searchTracks.checked=e.searchTracks,n.tools.controlPlayback.checked=e.controlPlayback,n.tools.getTopTracks.checked=e.getTopTracks,n.tools.getPlaylists.checked=e.getPlaylists;const i=(t,s,r,n)=>{t.addEventListener("input",(()=>{const i=t instanceof HTMLInputElement&&"checkbox"===t.type?t.checked:t.value;e[s]=r?r(i):i,n&&n(),Ee()}))};i(n.clientId,"clientId",(e=>e)),i(n.template,"template",(e=>e),De),i(n.role,"role",(e=>parseInt(e)),De),i(n.depth,"depth",(e=>parseInt(e)),De),i(n.scan,"scan",(e=>e),De),i(n.tools.searchTracks,"searchTracks",(e=>e),Ge),i(n.tools.controlPlayback,"controlPlayback",(e=>e),Ge),i(n.tools.getTopTracks,"getTopTracks",(e=>e),Ge),i(n.tools.getPlaylists,"getPlaylists",(e=>e),Ge),n.position.forEach((t=>{t.addEventListener("input",(t=>{e.position=parseInt(t.target.value),Ee()}))})),n.authButton.addEventListener("click",(()=>{!function(){$e(this,void 0,void 0,(function*(){const e=ge();if(!e.clientId)return void toastr.error(je`Please enter your Spotify Client ID in the settings.`);const t=function(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return crypto.getRandomValues(new Uint8Array(e)).reduce(((e,s)=>e+t[s%62]),"")}(64),s=yield function(e){const t=(new TextEncoder).encode(e),s=new ue;return s.update(t),s.digest()}(t),r=(n=s,btoa(String.fromCharCode(...new Uint8Array(n))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"));var n;const i=new URL("/callback/spotify",location.origin),a={response_type:"code",client_id:e.clientId,scope:fe.join(" "),redirect_uri:i.toString(),code_challenge_method:"S256",code_challenge:r};sessionStorage.setItem(de,t);const o=new URL("https://accounts.spotify.com/authorize");o.search=new URLSearchParams(a).toString(),window.location.href=o.toString()}))}()})),n.logoutButton.addEventListener("click",(()=>{e.clientToken=null,Ne(je`[Not logged in]`),Ee()}))}function Ne(e){const t=document.getElementById("spotify_user_name");t&&(t.innerText=e)}function Me(e){return $e(this,void 0,void 0,(function*(){const t=function(){const e=new URLSearchParams(window.location.search);if("spotify"!==e.get("source"))return null;const t=e.get("query");if(t){const e=new URLSearchParams(t).get("code");return window.history.replaceState({},document.title,window.location.pathname),e}return null}(),s=sessionStorage.getItem(de);if(!t||!s||!e.clientId)return;const r=new URL("/callback/spotify",window.location.origin),n={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:e.clientId,grant_type:"authorization_code",redirect_uri:r.toString(),code_verifier:s,code:t})};try{const t=yield fetch("https://accounts.spotify.com/api/token",n),s=yield t.json();e.clientToken=s,sessionStorage.removeItem(de),Ee(),console.log("Spotify token received:",s),toastr.success(je`Successfully authenticated with Spotify!`)}catch(e){console.error("Error during Spotify authentication:",e),toastr.error(je`Spotify authentication failed. Please try again.`)}}))}function He(e){return $e(this,void 0,void 0,(function*(){if(!e.clientToken||!e.clientId)return;const t=e.clientToken.expires,s=e.clientToken.refresh_token,r=Date.now();if(t&&t-r<3e5){const t="https://accounts.spotify.com/api/token",r={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:s,client_id:e.clientId})};try{const n=yield fetch(t,r),i=yield n.json();e.clientToken=i,e.clientToken&&!i.refresh_token&&(e.clientToken.refresh_token=s),console.log("Spotify token refreshed:",i),Ee()}catch(e){console.error("Error refreshing Spotify token:",e)}}}))}function De(){Fe(pe,"",ce.None,0)}function ze(){return $e(this,void 0,void 0,(function*(){De();const e=ge();if(e.clientToken&&e.clientId&&e.template)try{yield He(e);const t=H.withAccessToken(e.clientId,e.clientToken),s=yield t.player.getCurrentlyPlayingTrack();console.log("Currently playing Spotify track:",s);const r=function(e){var t;if(!e)return{};switch(e.type){case"track":{const s=e;return{song:s.name,artist:null===(t=s.artists.map((e=>e.name)))||void 0===t?void 0:t.join(", "),album:s.album.name,year:s.album.release_date.split("-")[0]}}case"show":{const t=e;return{song:t.name,artist:t.show.name}}}return{}}(s.item),n=Ue(e.template,r);Fe(pe,n,e.position,e.depth,e.scan,e.role)}catch(e){console.error("Error fetching currently playing track:",e)}}))}function Ke(e){var t;return{uri:e.uri,name:e.name,artist:null===(t=e.artists.map((e=>e.name)))||void 0===t?void 0:t.join(", "),album:e.album.name}}const Ve={searchTracks:{name:"SpotifySearchTracks",displayName:"Spotify: Search Tracks",description:"Search for tracks on Spotify. Call when you need to find a URI for a track.",parameters:ye.searchTracks,shouldRegister:()=>{const e=ge();return Promise.resolve(!(!e.clientToken||!e.clientId))},action:e=>$e(void 0,[e],void 0,(function*({query:e}){try{const t=ge();if(!t.clientToken||!t.clientId)return"User is not authenticated with Spotify.";yield He(t);const s=H.withAccessToken(t.clientId,t.clientToken),r=yield s.search(e,["track"]);return r.tracks.items.map(Ke)}catch(e){return console.error("Error searching tracks:",e),"Error searching tracks."}}))},controlPlayback:{name:"SpotifyControlPlayback",displayName:"Spotify: Control Playback",description:"Control playback on Spotify. Call when the user wants to play, pause, skip or seek a track.",parameters:ye.controlPlayback,shouldRegister:()=>{const e=ge();return Promise.resolve(!(!e.clientToken||!e.clientId))},action:e=>$e(void 0,[e],void 0,(function*({action:e,uri:t}){try{const s=ge();if(!s.clientToken||!s.clientId)return"User is not authenticated with Spotify.";yield He(s);const r=H.withAccessToken(s.clientId,s.clientToken),n=(yield r.player.getAvailableDevices()).devices.find((e=>e.is_active));switch(e){case"play":return t?(null==n?void 0:n.id)?(yield r.player.startResumePlayback(n.id,void 0,[t]),"Playing track: "+t):"No active device found.":"URI is required for play action.";case"pause":return(null==n?void 0:n.id)?(yield r.player.pausePlayback(n.id),"Paused playback on device: "+(null==n?void 0:n.name)):"No active device found.";case"resume":if(!(null==n?void 0:n.id))return"No active device found.";yield r.player.startResumePlayback(n.id);case"next":return(null==n?void 0:n.id)?(yield r.player.skipToNext(n.id),"Skipped to next track on device: "+(null==n?void 0:n.name)):"No active device found.";case"previous":return(null==n?void 0:n.id)?(yield r.player.skipToPrevious(n.id),"Skipped to previous track on device: "+(null==n?void 0:n.name)):"No active device found.";default:return"Unknown action: "+e}}catch(e){return console.error("Error controlling playback:",e),"Error controlling playback."}}))},getTopTracks:{name:"SpotifyGetTopTracks",displayName:"Spotify: Get Top Tracks",description:"Gets a list of user's top tracks. Call when the user wants to see their top tracks, play a favorite track, etc.",parameters:ye.getTopTracks,shouldRegister:()=>{const e=ge();return Promise.resolve(!(!e.clientToken||!e.clientId))},action:e=>$e(void 0,[e],void 0,(function*({timeRange:e}){try{const t=ge();if(!t.clientToken||!t.clientId)return"User is not authenticated with Spotify.";yield He(t);const s=H.withAccessToken(t.clientId,t.clientToken);["short_term","medium_term","long_term"].includes(e)||(e="short_term");const r=yield s.currentUser.topItems("tracks",e);return r.items.map(Ke)}catch(e){return console.error("Error fetching top tracks:",e),"Error fetching top tracks."}}))},getPlaylists:{name:"SpotifyGetPlaylists",displayName:"Spotify: Get Playlists",description:"Gets a list of user's playlists. Call when the user wants to see their playlists.",parameters:ye.getPlaylists,shouldRegister:()=>{const e=ge();return Promise.resolve(!(!e.clientToken||!e.clientId))},action:()=>$e(void 0,void 0,void 0,(function*(){try{const e=ge();if(!e.clientToken||!e.clientId)return"User is not authenticated with Spotify.";yield He(e);const t=H.withAccessToken(e.clientId,e.clientToken),s=yield t.currentUser.playlists.playlists();return s.items.map((e=>({uri:e.uri,name:e.name,description:e.description})))}catch(e){return console.error("Error fetching playlists:",e),"Error fetching playlists."}}))}};function Ge(){const e=ge();for(const[t,s]of Object.entries(Ve))e[t]?Oe(s):Le(t)}!function(){$e(this,void 0,void 0,(function*(){const e=ge();Be(e),yield Me(e),yield He(e),yield function(e){return $e(this,void 0,void 0,(function*(){if(e.clientToken&&e.clientId)try{const t=H.withAccessToken(e.clientId,e.clientToken),s=yield t.currentUser.profile();Ne(s.display_name||s.id)}catch(t){console.error("Error fetching user data:",t),e.clientToken=null,Ne("[Token expired]")}else Ne(je`[Not logged in]`)}))}(e),globalThis.spotify_setCurrentTrack=ze,Ge(),Ee()}))}()})();